<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEAP Pro - Landholder Environmental Action Planner</title>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Leaflet Mapping -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <link href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" rel="stylesheet"/>
    
    <!-- Mapping Extensions -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.76.1/dist/L.Control.Locate.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.76.1/dist/L.Control.Locate.min.css" rel="stylesheet"/>
    <script src="https://unpkg.com/leaflet-geosearch@3.8.0/dist/geosearch.umd.js"></script>
    <link href="https://unpkg.com/leaflet-geosearch@3.8.0/assets/css/leaflet.css" rel="stylesheet" />
    
    <!-- Export & Utilities -->
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- UI Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #1a5d1a;
            --secondary: #2d936c;
            --accent: #4CAF50;
            --warning: #ff9800;
            --danger: #f44336;
            --info: #2196F3;
        }
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
        }
        
        #map { 
            height: 500px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .zone-management { background-color: rgba(33, 150, 243, 0.15); border-color: #2196F3; }
        .zone-problem { background-color: rgba(244, 67, 54, 0.15); border-color: #f44336; }
        .zone-sensitive { background-color: rgba(76, 175, 80, 0.15); border-color: #4CAF50; }
        .zone-other { background-color: rgba(255, 152, 0, 0.15); border-color: #ff9800; }
        
        .zone-label-text {
            background-color: white;
            padding: 4px 10px;
            border-radius: 6px;
            border: 2px solid #333;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .splash-container {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(26, 93, 26, 0.3);
        }
        
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(26, 93, 26, 0.2);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(26, 93, 26, 0.3);
        }
        
        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
            padding: 12px 28px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: var(--primary);
            color: white;
        }
        
        .progress-bar {
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
            transition: width 0.5s ease;
        }
        
        .step-indicator {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .step-active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(26, 93, 26, 0.3);
        }
        
        .step-completed {
            background: var(--secondary);
            color: white;
        }
        
        .step-inactive {
            background: #e9ecef;
            color: #6c757d;
        }
        
        .priority-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .priority-high { background: #fee; color: #c53030; border: 1px solid #feb2b2; }
        .priority-medium { background: #fffbeb; color: #b45309; border: 1px solid #fcd34d; }
        .priority-low { background: #f0fff4; color: #2f855a; border: 1px solid #9ae6b4; }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .floating-action-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 25px rgba(26, 93, 26, 0.4);
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .floating-action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 30px rgba(26, 93, 26, 0.5);
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .accordion-item {
            border: 1px solid #e9ecef;
            border-radius: 10px;
            margin-bottom: 12px;
            overflow: hidden;
        }
        
        .accordion-header {
            padding: 18px 24px;
            background: #f8f9fa;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            transition: background 0.2s ease;
        }
        
        .accordion-header:hover {
            background: #e9ecef;
        }
        
        .accordion-content {
            padding: 24px;
            background: white;
            border-top: 1px solid #e9ecef;
            display: none;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.2s ease;
        }
        
        .form-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 93, 26, 0.1);
            outline: none;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 93, 26, 0.1);
            outline: none;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
            border-bottom: 1px dotted #666;
            cursor: help;
        }
        
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 300px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 14px;
            font-weight: normal;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-left: 5px solid var(--primary);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 20px;
            color: white;
            font-size: 24px;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
        }
        
        .leaflet-container {
            font-family: 'Inter', sans-serif !important;
        }
        
        .custom-marker {
            background: transparent !important;
            border: none !important;
        }

        .leaflet-popup-content {
            font-family: 'Inter', sans-serif !important;
            min-width: 220px !important;
        }

        .leaflet-popup-content-wrapper {
            border-radius: 10px !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        }

        .leaflet-popup-close-button {
            font-size: 18px !important;
            padding: 8px !important;
        }

        .leaflet-draw-toolbar {
            margin-top: 10px !important;
        }

        .leaflet-draw-toolbar a {
            background-color: white !important;
            border: 1px solid #ddd !important;
            border-radius: 4px !important;
            margin: 2px !important;
        }

        .leaflet-draw-toolbar a:hover {
            background-color: #f8f9fa !important;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef, useContext } = React;
        
        // Create context for global state
        const AppContext = React.createContext();
        
        // Utility functions
        const formatDate = (date) => {
            return new Date(date).toLocaleDateString('en-AU', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        };
        
        // Enhanced sample data with more comprehensive information
        const sampleWeeds = {
            'NSW': [
                { name: 'African lovegrass', category: 'grass', control: 'Herbicide application, pasture improvement', season: 'Spring-Summer' },
                { name: 'Blackberry', category: 'shrub', control: 'Cut-stump herbicide, biological control', season: 'Late winter' },
                { name: 'Gorse', category: 'shrub', control: 'Herbicide, mechanical removal', season: 'Year-round' },
                { name: 'Lantana', category: 'shrub', control: 'Herbicide, mechanical removal', season: 'Spring-Autumn' },
                { name: 'Serrated tussock', category: 'grass', control: 'Herbicide, competitive pasture', season: 'Spring' }
            ],
            'VIC': [
                { name: 'Bridal creeper', category: 'vine', control: 'Herbicide, biological control', season: 'Winter-Spring' },
                { name: 'Gorse', category: 'shrub', control: 'Herbicide, mechanical removal', season: 'Year-round' },
                { name: 'Paterson\'s curse', category: 'herb', control: 'Herbicide, grazing management', season: 'Autumn-Spring' },
                { name: 'Willows', category: 'tree', control: 'Cut-stump herbicide', season: 'Summer-Autumn' },
                { name: 'English broom', category: 'shrub', control: 'Herbicide, mechanical removal', season: 'Spring' }
            ],
            'QLD': [
                { name: 'Lantana', category: 'shrub', control: 'Herbicide, mechanical removal', season: 'Spring-Autumn' },
                { name: 'Parthenium weed', category: 'herb', control: 'Herbicide, competitive pasture', season: 'Year-round' },
                { name: 'Pond apple', category: 'tree', control: 'Cut-stump herbicide', season: 'Any' },
                { name: 'Rubber vine', category: 'vine', control: 'Herbicide, mechanical removal', season: 'Wet season' },
                { name: 'Singapore daisy', category: 'ground cover', control: 'Herbicide, manual removal', season: 'Year-round' }
            ],
            'WA': [
                { name: 'Arum lily', category: 'herb', control: 'Herbicide, manual removal', season: 'Winter-Spring' },
                { name: 'Bridal creeper', category: 'vine', control: 'Herbicide, biological control', season: 'Winter-Spring' },
                { name: 'Watsonia', category: 'bulb', control: 'Herbicide, bulb removal', season: 'Spring' },
                { name: 'Geraldton carnation weed', category: 'herb', control: 'Herbicide, competitive pasture', season: 'Winter-Spring' },
                { name: 'Ehrharta', category: 'grass', control: 'Herbicide, pasture improvement', season: 'Autumn-Spring' }
            ],
            'SA': [
                { name: 'Olive', category: 'tree', control: 'Cut-stump herbicide', season: 'Any' },
                { name: 'Bridal creeper', category: 'vine', control: 'Herbicide, biological control', season: 'Winter-Spring' },
                { name: 'Geraldton carnation weed', category: 'herb', control: 'Herbicide, competitive pasture', season: 'Winter-Spring' },
                { name: 'Buffel grass', category: 'grass', control: 'Herbicide, competitive natives', season: 'Summer-Autumn' },
                { name: 'Horehound', category: 'herb', control: 'Herbicide, competitive pasture', season: 'Spring-Summer' }
            ],
            'TAS': [
                { name: 'Gorse', category: 'shrub', control: 'Herbicide, mechanical removal', season: 'Year-round' },
                { name: 'Broom', category: 'shrub', control: 'Herbicide, mechanical removal', season: 'Spring' },
                { name: 'Willows', category: 'tree', control: 'Cut-stump herbicide', season: 'Summer-Autumn' },
                { name: 'Holly', category: 'tree', control: 'Cut-stump herbicide', season: 'Any' },
                { name: 'Spanish heath', category: 'shrub', control: 'Herbicide, mechanical removal', season: 'Spring' }
            ],
            'NT': [
                { name: 'Gamba grass', category: 'grass', control: 'Herbicide, fire management', season: 'Wet season' },
                { name: 'Parkinsonia', category: 'tree', control: 'Cut-stump herbicide', season: 'Dry season' },
                { name: 'Rubber vine', category: 'vine', control: 'Herbicide, mechanical removal', season: 'Wet season' },
                { name: 'Pond apple', category: 'tree', control: 'Cut-stump herbicide', season: 'Any' },
                { name: 'Mimosa pigra', category: 'shrub', control: 'Herbicide, mechanical removal', season: 'Wet season' }
            ]
        };
        
        const fundingPrograms = {
            'NSW': [
                { name: 'Landcare grants', provider: 'Local Land Services', amount: '$5,000-$50,000', deadline: 'Ongoing' },
                { name: 'Bushfire recovery funding', provider: 'NSW Government', amount: 'Up to $75,000', deadline: '30/06/2024' },
                { name: 'Biodiversity conservation trust', provider: 'BCT', amount: 'Varies', deadline: 'Multiple rounds' }
            ],
            'VIC': [
                { name: 'Catchment management grants', provider: 'CMA', amount: '$2,000-$100,000', deadline: 'Ongoing' },
                { name: 'Landcare grants', provider: 'Landcare Victoria', amount: '$5,000-$30,000', deadline: '15/04/2024' },
                { name: 'Bushfire biodiversity recovery', provider: 'DELWP', amount: 'Up to $50,000', deadline: '30/09/2024' }
            ],
            'QLD': [
                { name: 'Land restoration fund', provider: 'QLD Government', amount: '$10,000-$500,000', deadline: 'Multiple rounds' },
                { name: 'Reef Trust', provider: 'QLD Government', amount: 'Varies', deadline: 'Ongoing' },
                { name: 'Natural resource grants', provider: 'NRM', amount: '$5,000-$100,000', deadline: '30/06/2024' }
            ],
            'WA': [
                { name: 'State NRM program', provider: 'WA Government', amount: '$5,000-$75,000', deadline: 'Ongoing' },
                { name: 'Landcare grants', provider: 'Landcare WA', amount: '$3,000-$25,000', deadline: '31/05/2024' },
                { name: 'Community stewardship', provider: 'DPIRD', amount: 'Up to $50,000', deadline: 'Multiple rounds' }
            ],
            'SA': [
                { name: 'Landscape board grants', provider: 'Landscape SA', amount: '$2,000-$60,000', deadline: 'Ongoing' },
                { name: 'Native vegetation grants', provider: 'DEW', amount: '$5,000-$30,000', deadline: '15/08/2024' },
                { name: 'Soil conservation grants', provider: 'SA Government', amount: 'Up to $25,000', deadline: '30/11/2024' }
            ],
            'TAS': [
                { name: 'NRM North grants', provider: 'NRM North', amount: '$1,000-$40,000', deadline: 'Ongoing' },
                { name: 'Landcare grants', provider: 'Landcare Tasmania', amount: '$3,000-$20,000', deadline: '30/04/2024' },
                { name: 'Private land conservation', provider: 'DPIPWE', amount: 'Varies', deadline: 'Multiple rounds' }
            ],
            'NT': [
                { name: 'Landcare grants', provider: 'Landcare NT', amount: '$5,000-$30,000', deadline: 'Ongoing' },
                { name: 'Indigenous ranger programs', provider: 'NLC', amount: 'Varies', deadline: 'Multiple rounds' },
                { name: 'Desert knowledge grants', provider: 'DKCRC', amount: 'Up to $50,000', deadline: '30/09/2024' }
            ]
        };
        
        // Error Boundary Component
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }

            componentDidCatch(error, errorInfo) {
                console.error("LEAP Error:", error, errorInfo);
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="card max-w-2xl mx-auto my-8">
                            <div className="text-center p-8">
                                <div className="text-red-500 text-5xl mb-4">
                                    <i className="fas fa-exclamation-triangle"></i>
                                </div>
                                <h3 className="text-xl font-bold mb-2">Something went wrong</h3>
                                <p className="text-gray-600 mb-4">We encountered an error while loading the application.</p>
                                <button 
                                    onClick={() => window.location.reload()}
                                    className="btn-primary"
                                >
                                    <i className="fas fa-redo mr-2"></i> Reload Application
                                </button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // Main App Component
        function App() {
            const [currentStep, setCurrentStep] = useState(0);
            const [isLoading, setIsLoading] = useState(true);
            const [showHelp, setShowHelp] = useState(false);
            const [activeModal, setActiveModal] = useState(null);
            const [formData, setFormData] = useState(() => {
                const savedData = localStorage.getItem('leapFormData');
                const defaultData = {
                    property: {
                        name: '',
                        size: '',
                        location: '',
                        state: '',
                        features: [],
                        rainfall: '',
                        soilType: '',
                        coordinates: null,
                        elevation: '',
                        aspect: '',
                        vegetation: []
                    },
                    problems: {
                        erosion: { present: false, severity: 'low', type: '', notes: '' },
                        weeds: [],
                        habitatLoss: { present: false, severity: 'low', type: '', notes: '' },
                        waterQuality: { present: false, severity: 'low', type: '', notes: '' },
                        fireRisk: { present: false, severity: 'low', type: '', notes: '' },
                        salinity: { present: false, severity: 'low', notes: '' },
                        feralAnimals: { present: false, species: [], notes: '' },
                        otherProblems: '',
                        goals: []
                    },
                    mapZones: [],
                    recommendations: [],
                    timeline: [],
                    photos: [],
                    budget: {
                        estimatedCost: 0,
                        fundingSources: [],
                        timeline: []
                    },
                    contacts: []
                };
                
                return savedData ? JSON.parse(savedData) : defaultData;
            });

            const steps = [
                { title: 'Dashboard', icon: 'ðŸ ', description: 'Overview & Quick Start' },
                { title: 'Property Profile', icon: 'ðŸ“‹', description: 'Property Details & Features' },
                { title: 'Assessment', icon: 'âš ï¸', description: 'Identify Issues & Goals' },
                { title: 'Property Mapping', icon: 'ðŸ—ºï¸', description: 'Map Zones & Features' },
                { title: 'Action Plan', icon: 'ðŸ’¡', description: 'Recommendations & Solutions' },
                { title: 'Implementation', icon: 'ðŸ“…', description: 'Timeline & Budget' },
                { title: 'Resources', icon: 'ðŸ”—', description: 'Funding & Contacts' },
                { title: 'Export', icon: 'ðŸ“¤', description: 'Share & Download' }
            ];

            // Load data on mount
            useEffect(() => {
                const init = () => {
                    try {
                        // Check for URL parameters (for sharing)
                        const urlParams = new URLSearchParams(window.location.search);
                        if (urlParams.has('template')) {
                            loadTemplate(urlParams.get('template'));
                        }
                        
                        setIsLoading(false);
                    } catch (error) {
                        console.error('Initialization error:', error);
                        setIsLoading(false);
                    }
                };
                
                init();
            }, []);

            // Save to localStorage whenever formData changes
            useEffect(() => {
                if (!isLoading) {
                    try {
                        localStorage.setItem('leapFormData', JSON.stringify(formData));
                    } catch (error) {
                        console.error('Error saving to localStorage:', error);
                    }
                }
            }, [formData, isLoading]);

            const loadTemplate = (templateName) => {
                // Load predefined templates based on council/group type
                const templates = {
                    'landcare': {
                        property: {
                            features: ['Native vegetation', 'Creeks or rivers', 'Pasture areas'],
                            goals: ['Improve biodiversity', 'Control invasive species', 'Create wildlife habitat']
                        }
                    },
                    'council': {
                        problems: {
                            erosion: { present: true, severity: 'medium' },
                            weeds: ['African lovegrass', 'Blackberry'],
                            goals: ['Reduce erosion', 'Improve water quality', 'Enhance farm productivity']
                        }
                    }
                };
                
                if (templates[templateName]) {
                    setFormData(prev => ({
                        ...prev,
                        ...templates[templateName]
                    }));
                    alert(`Loaded ${templateName} template`);
                }
            };

            const nextStep = () => {
                if (currentStep === 1 && !formData.property.name) {
                    alert('Please provide a property name');
                    return;
                }
                setCurrentStep(prev => Math.min(prev + 1, steps.length - 1));
            };
            
            const prevStep = () => setCurrentStep(prev => Math.max(prev - 1, 0));

            const updateFormData = (section, data) => {
                setFormData(prev => ({
                    ...prev,
                    [section]: { ...prev[section], ...data }
                }));
            };

            const addMapZone = (zone) => {
                setFormData(prev => ({
                    ...prev,
                    mapZones: [...prev.mapZones, { ...zone, id: Date.now() }]
                }));
            };

            const updateZone = (id, updates) => {
                setFormData(prev => ({
                    ...prev,
                    mapZones: prev.mapZones.map(zone => 
                        zone.id === id ? { ...zone, ...updates } : zone
                    )
                }));
            };

            const removeZone = (id) => {
                setFormData(prev => ({
                    ...prev,
                    mapZones: prev.mapZones.filter(zone => zone.id !== id)
                }));
            };

            const addPhoto = (photo) => {
                setFormData(prev => ({
                    ...prev,
                    photos: [...prev.photos, { ...photo, id: Date.now(), date: new Date().toISOString() }]
                }));
            };

            const removePhoto = (id) => {
                setFormData(prev => ({
                    ...prev,
                    photos: prev.photos.filter(photo => photo.id !== id)
                }));
            };

            const addContact = (contact) => {
                setFormData(prev => ({
                    ...prev,
                    contacts: [...prev.contacts, { ...contact, id: Date.now() }]
                }));
            };

            const clearLocalStorage = () => {
                if (confirm('Are you sure you want to clear all saved data? This cannot be undone.')) {
                    localStorage.removeItem('leapFormData');
                    setFormData({
                        property: {
                            name: '',
                            size: '',
                            location: '',
                            state: '',
                            features: [],
                            rainfall: '',
                            soilType: '',
                            coordinates: null,
                            elevation: '',
                            aspect: '',
                            vegetation: []
                        },
                        problems: {
                            erosion: { present: false, severity: 'low', type: '', notes: '' },
                            weeds: [],
                            habitatLoss: { present: false, severity: 'low', type: '', notes: '' },
                            waterQuality: { present: false, severity: 'low', type: '', notes: '' },
                            fireRisk: { present: false, severity: 'low', type: '', notes: '' },
                            salinity: { present: false, severity: 'low', notes: '' },
                            feralAnimals: { present: false, species: [], notes: '' },
                            otherProblems: '',
                            goals: []
                        },
                        mapZones: [],
                        recommendations: [],
                        timeline: [],
                        photos: [],
                        budget: {
                            estimatedCost: 0,
                            fundingSources: [],
                            timeline: []
                        },
                        contacts: []
                    });
                    setCurrentStep(0);
                    alert('All saved data has been cleared. Starting fresh.');
                }
            };

            const generateRecommendations = () => {
                try {
                    const recs = [];
                    const timeline = [];
                    const budgetItems = [];
                    
                    // Detailed weed management recommendations
                    if (formData.problems.weeds.length > 0) {
                        const stateWeeds = sampleWeeds[formData.property.state] || [];
                        const detailedWeeds = formData.problems.weeds.map(weedName => {
                            return stateWeeds.find(w => w.name === weedName) || { name: weedName };
                        });
                        
                        const weedRec = {
                            title: 'Integrated Weed Management Plan',
                            category: 'vegetation',
                            actions: [
                                'Conduct a detailed weed mapping exercise to identify infestation boundaries',
                                'Prioritize control based on weed invasiveness and site accessibility',
                                'Implement a combination of control methods: mechanical, chemical, biological',
                                'Develop a monitoring schedule to assess control effectiveness',
                                'Establish competitive ground cover to prevent re-invasion'
                            ],
                            priority: 'high',
                            whyImportant: 'Effective weed management prevents loss of productive land, protects native biodiversity, reduces fire fuel loads, and maintains ecosystem function.',
                            resources: fundingPrograms[formData.property.state] || [],
                            estimatedCost: 5000,
                            timeframe: '6-24 months',
                            detailedWeeds: detailedWeeds
                        };
                        
                        recs.push(weedRec);
                        
                        budgetItems.push({
                            item: 'Weed control program',
                            cost: 5000,
                            priority: 'high',
                            timeframe: 'Months 1-6'
                        });
                        
                        timeline.push({
                            action: 'Initial weed assessment and mapping',
                            timeframe: '1-2 months',
                            season: getBestSeason(formData.property.state, 'weeds'),
                            priority: 'high',
                            details: 'Map all weed infestations, identify species, and assess densities',
                            responsible: 'Landholder + NRM officer'
                        });
                    }
                    
                    // Erosion control with engineering solutions
                    if (formData.problems.erosion.present) {
                        const severity = formData.problems.erosion.severity;
                        const erosionRec = {
                            title: 'Erosion Control and Soil Conservation',
                            category: 'soil',
                            actions: severity === 'high' ? [
                                'Install structural erosion control measures (check dams, silt fences)',
                                'Construct contour banks in cropping areas',
                                'Implement grade stabilization structures in drainage lines',
                                'Revegetate with deep-rooted native grasses and shrubs',
                                'Establish windbreaks in areas prone to wind erosion'
                            ] : [
                                'Implement vegetative buffers along waterways',
                                'Reduce ground disturbance through rotational grazing',
                                'Maintain ground cover year-round',
                                'Use contour planting in sloping areas',
                                'Monitor erosion hotspots quarterly'
                            ],
                            priority: severity === 'high' ? 'high' : 'medium',
                            whyImportant: 'Soil erosion leads to loss of productive topsoil, reduced water quality, sedimentation of waterways, and decreased land productivity.',
                            resources: [],
                            estimatedCost: severity === 'high' ? 15000 : 5000,
                            timeframe: severity === 'high' ? '3-12 months' : '6-24 months'
                        };
                        
                        recs.push(erosionRec);
                        
                        budgetItems.push({
                            item: 'Erosion control works',
                            cost: severity === 'high' ? 15000 : 5000,
                            priority: severity === 'high' ? 'high' : 'medium',
                            timeframe: severity === 'high' ? 'Months 1-3' : 'Months 3-12'
                        });
                    }
                    
                    // Habitat restoration with ecological considerations
                    if (formData.problems.habitatLoss.present || formData.problems.goals.includes('Improve biodiversity')) {
                        const habitatRec = {
                            title: 'Habitat Restoration and Connectivity',
                            category: 'biodiversity',
                            actions: [
                                'Plant locally indigenous vegetation in strategic locations',
                                'Create wildlife corridors to connect habitat patches',
                                'Install nest boxes for hollow-dependent species',
                                'Control feral predators where necessary',
                                'Monitor wildlife usage with camera traps',
                                'Consider fencing to protect sensitive regeneration areas'
                            ],
                            priority: 'medium',
                            whyImportant: 'Habitat restoration increases biodiversity, supports ecosystem services (pollination, pest control), enhances landscape resilience, and provides climate adaptation benefits.',
                            resources: [],
                            estimatedCost: 10000,
                            timeframe: '12-36 months'
                        };
                        
                        recs.push(habitatRec);
                        
                        budgetItems.push({
                            item: 'Habitat restoration planting',
                            cost: 10000,
                            priority: 'medium',
                            timeframe: 'Months 6-18'
                        });
                    }
                    
                    // Water quality management plan
                    if (formData.problems.waterQuality.present || formData.property.features.includes('Creeks or rivers')) {
                        const waterRec = {
                            title: 'Waterway and Riparian Management',
                            category: 'water',
                            actions: [
                                'Fence waterways to exclude stock (minimum 30m buffer)',
                                'Revegetate riparian zones with native sedges, rushes and trees',
                                'Install off-stream watering points for livestock',
                                'Monitor water quality parameters quarterly',
                                'Control erosion in catchment areas',
                                'Manage nutrient runoff from agricultural areas'
                            ],
                            priority: 'medium',
                            whyImportant: 'Healthy waterways provide clean water, support aquatic ecosystems, reduce flood risk, maintain stream stability, and enhance landscape values.',
                            resources: [],
                            estimatedCost: 8000,
                            timeframe: '6-24 months'
                        };
                        
                        recs.push(waterRec);
                    }
                    
                    // Fire management with planning
                    if (formData.problems.fireRisk.present) {
                        const fireRec = {
                            title: 'Bushfire Risk Management',
                            category: 'fire',
                            actions: [
                                'Create and maintain asset protection zones around buildings',
                                'Develop a comprehensive fire management plan',
                                'Implement strategic fuel reduction program',
                                'Establish and maintain fire access trails',
                                'Install water supply points for firefighting',
                                'Participate in local fire planning committees'
                        ],
                            priority: 'high',
                            whyImportant: 'Proactive fire management protects life and property, reduces wildfire intensity, maintains ecosystem health through appropriate fire regimes, and supports community safety.',
                            resources: [],
                            estimatedCost: 12000,
                            timeframe: '3-12 months'
                        };
                        
                        recs.push(fireRec);
                    }
                    
                    // Carbon farming opportunities
                    if (formData.problems.goals.includes('Carbon sequestration')) {
                        const carbonRec = {
                            title: 'Carbon Farming and Storage',
                            category: 'climate',
                            actions: [
                                'Implement rotational grazing to increase soil carbon',
                                'Plant permanent native vegetation in marginal areas',
                                'Reduce tillage intensity in cropping systems',
                                'Investigate carbon farming methodology eligibility',
                                'Monitor soil carbon levels over time',
                                'Explore carbon market opportunities'
                            ],
                            priority: 'medium',
                            whyImportant: 'Increasing carbon sequestration mitigates climate change, improves soil health and fertility, enhances water retention, and can generate additional farm income.',
                            resources: [],
                            estimatedCost: 7000,
                            timeframe: '12-60 months'
                        };
                        
                        recs.push(carbonRec);
                    }
                    
                    // Calculate total budget
                    const totalCost = budgetItems.reduce((sum, item) => sum + item.cost, 0);
                    
                    // Update state with generated data
                    setFormData(prev => ({
                        ...prev,
                        recommendations: recs,
                        timeline: timeline,
                        budget: {
                            ...prev.budget,
                            estimatedCost: totalCost,
                            items: budgetItems
                        }
                    }));
                } catch (error) {
                    console.error('Error generating recommendations:', error);
                }
            };

            const getBestSeason = (state, actionType) => {
                const seasons = {
                    'NSW': { weeds: 'Spring', planting: 'Autumn', burning: 'Autumn', earthworks: 'Summer' },
                    'VIC': { weeds: 'Spring', planting: 'Autumn', burning: 'Autumn', earthworks: 'Summer' },
                    'QLD': { weeds: 'Wet season', planting: 'Wet season', burning: 'Dry season', earthworks: 'Dry season' },
                    'WA': { weeds: 'Spring', planting: 'Winter', burning: 'Autumn', earthworks: 'Summer' },
                    'SA': { weeds: 'Spring', planting: 'Autumn', burning: 'Autumn', earthworks: 'Summer' },
                    'TAS': { weeds: 'Spring', planting: 'Spring', burning: 'Autumn', earthworks: 'Summer' },
                    'NT': { weeds: 'Wet season', planting: 'Wet season', burning: 'Dry season', earthworks: 'Dry season' }
                };
                
                return seasons[state]?.[actionType] || 'Spring';
            };

            const getStepHelpContent = (step) => {
                const helpContent = {
                    0: "Dashboard provides an overview and quick access to templates. Start a new plan or continue an existing one.",
                    1: "Enter detailed property information including location, size, soil type, and features. This forms the foundation of your plan.",
                    2: "Identify environmental issues and set management goals. Be thorough - this drives your action plan recommendations.",
                    3: "Use the interactive map to mark zones and problem areas. Add photos to document site conditions.",
                    4: "Review automatically generated recommendations based on your assessment. Each includes priority, timeframe, and estimated cost.",
                    5: "Create an implementation timeline and budget. Filter actions by timeframe to focus on immediate priorities.",
                    6: "Find funding opportunities specific to your state and add key contacts for implementation support.",
                    7: "Export your plan as a professional PDF report. You can also export data in other formats for sharing."
                };
                return helpContent[step] || "This step helps you create your environmental action plan.";
            };

            useEffect(() => {
                if (currentStep === 4) {
                    generateRecommendations();
                }
            }, [currentStep]);

            const renderStep = () => {
                switch(currentStep) {
                    case 0:
                        return <Dashboard 
                            formData={formData} 
                            nextStep={nextStep}
                            clearLocalStorage={clearLocalStorage}
                        />;
                    case 1:
                        return <PropertyForm 
                            data={formData.property} 
                            update={(data) => updateFormData('property', data)} 
                            sampleWeeds={sampleWeeds}
                        />;
                    case 2:
                        return <AssessmentForm 
                            data={formData.problems} 
                            update={(data) => updateFormData('problems', data)} 
                            sampleWeeds={sampleWeeds}
                            state={formData.property.state}
                        />;
                    case 3:
                        return <MapTool 
                            zones={formData.mapZones} 
                            addZone={addMapZone}
                            updateZone={updateZone}
                            removeZone={removeZone}
                            propertyName={formData.property.name}
                            location={formData.property.location}
                            coordinates={formData.property.coordinates}
                            photos={formData.photos}
                            addPhoto={addPhoto}
                            removePhoto={removePhoto}
                        />;
                    case 4:
                        return <ActionPlan 
                            recommendations={formData.recommendations} 
                            problems={formData.problems}
                        />;
                    case 5:
                        return <Implementation 
                            timeline={formData.timeline} 
                            budget={formData.budget}
                            recommendations={formData.recommendations}
                        />;
                    case 6:
                        return <Resources 
                            state={formData.property.state}
                            contacts={formData.contacts}
                            addContact={addContact}
                            fundingPrograms={fundingPrograms}
                        />;
                    case 7:
                        return <ExportPanel 
                            formData={formData} 
                            clearLocalStorage={clearLocalStorage}
                        />;
                    default:
                        return <Dashboard 
                            formData={formData} 
                            nextStep={nextStep}
                            clearLocalStorage={clearLocalStorage}
                        />;
                }
            };

            return (
                <AppContext.Provider value={{ formData, setFormData, activeModal, setActiveModal }}>
                    <div className="min-h-screen flex flex-col">
                        {/* Header */}
                        <header className="bg-white shadow-sm border-b">
                            <div className="container mx-auto px-4 py-3">
                                <div className="flex justify-between items-center">
                                    <div className="flex items-center">
                                        <div className="bg-green-100 p-2 rounded-lg mr-3">
                                            <i className="fas fa-leaf text-green-600 text-2xl"></i>
                                        </div>
                                        <div>
                                            <h1 className="text-2xl font-bold text-green-800">LEAP Pro</h1>
                                            <p className="text-sm text-gray-600">Landholder Environmental Action Planner</p>
                                        </div>
                                    </div>
                                    
                                    <div className="flex items-center space-x-4">
                                        {formData.property.name && (
                                            <div className="hidden md:block bg-green-50 px-4 py-2 rounded-lg">
                                                <span className="text-sm font-medium text-green-700">
                                                    <i className="fas fa-map-marker-alt mr-2"></i>
                                                    {formData.property.name}
                                                </span>
                                            </div>
                                        )}
                                        
                                        <button 
                                            onClick={() => setShowHelp(!showHelp)}
                                            className="bg-gray-100 hover:bg-gray-200 p-2 rounded-lg"
                                            title="Help & Support"
                                        >
                                            <i className="fas fa-question-circle text-gray-600"></i>
                                        </button>
                                        
                                        <button 
                                            onClick={() => setActiveModal('settings')}
                                            className="bg-gray-100 hover:bg-gray-200 p-2 rounded-lg"
                                            title="Settings"
                                        >
                                            <i className="fas fa-cog text-gray-600"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </header>
                        
                        {/* Progress Navigation */}
                        <div className="bg-white border-b">
                            <div className="container mx-auto px-4 py-4">
                                <div className="flex items-center justify-between mb-4">
                                    <div>
                                        <h2 className="text-lg font-bold text-gray-800">{steps[currentStep].title}</h2>
                                        <p className="text-sm text-gray-600">{steps[currentStep].description}</p>
                                    </div>
                                    <div className="text-sm text-gray-500">
                                        Step {currentStep + 1} of {steps.length}
                                    </div>
                                </div>
                                
                                <div className="flex justify-between items-center">
                                    <div className="flex space-x-2 flex-1">
                                        {steps.map((step, index) => (
                                            <div key={index} className="flex-1 flex flex-col items-center">
                                                <button
                                                    onClick={() => setCurrentStep(index)}
                                                    className={`step-indicator ${
                                                        currentStep === index ? 'step-active' :
                                                        currentStep > index ? 'step-completed' : 'step-inactive'
                                                    }`}
                                                >
                                                    {currentStep > index ? (
                                                        <i className="fas fa-check"></i>
                                                    ) : (
                                                        <span className="text-sm">{index + 1}</span>
                                                    )}
                                                </button>
                                                <span className="text-xs mt-2 text-center hidden md:block">{step.title}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {/* Main Content */}
                        <main className="flex-grow container mx-auto px-4 py-8">
                            <ErrorBoundary>
                                {isLoading ? (
                                    <div className="flex justify-center items-center h-64">
                                        <div className="text-center">
                                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-green-600 mx-auto mb-4"></div>
                                            <p className="text-gray-600">Loading LEAP Application...</p>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="fade-in">
                                        {renderStep()}
                                    </div>
                                )}
                            </ErrorBoundary>
                        </main>
                        
                        {/* Navigation Footer */}
                        <footer className="bg-white border-t">
                            <div className="container mx-auto px-4 py-4">
                                <div className="flex justify-between items-center">
                                    <button 
                                        onClick={prevStep}
                                        disabled={currentStep === 0}
                                        className={`flex items-center px-6 py-3 rounded-lg ${
                                            currentStep === 0 
                                            ? 'bg-gray-100 text-gray-400 cursor-not-allowed' 
                                            : 'bg-gray-100 hover:bg-gray-200 text-gray-700'
                                        }`}
                                    >
                                        <i className="fas fa-arrow-left mr-2"></i>
                                        Previous
                                    </button>
                                    
                                    <div className="flex space-x-3">
                                        <button 
                                            onClick={() => setActiveModal('save')}
                                            className="px-6 py-3 rounded-lg border border-green-600 text-green-600 hover:bg-green-50"
                                        >
                                            <i className="far fa-save mr-2"></i>
                                            Save Draft
                                        </button>
                                        
                                        <button 
                                            onClick={nextStep}
                                            className={`btn-primary flex items-center ${
                                                currentStep === steps.length - 1 ? 'hidden' : ''
                                            }`}
                                        >
                                            {currentStep === steps.length - 2 ? 'Finalize' : 'Next'}
                                            <i className="fas fa-arrow-right ml-2"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </footer>
                        
                        {/* Help Modal */}
                        {showHelp && (
                            <div className="modal-overlay" onClick={() => setShowHelp(false)}>
                                <div className="modal-content max-w-4xl" onClick={e => e.stopPropagation()}>
                                    <div className="p-0">
                                        <div className="flex justify-between items-center mb-0 p-6 border-b">
                                            <h3 className="text-xl font-bold">Help & Support Center</h3>
                                            <button 
                                                onClick={() => setShowHelp(false)}
                                                className="text-gray-400 hover:text-gray-600"
                                            >
                                                <i className="fas fa-times text-xl"></i>
                                            </button>
                                        </div>
                                        
                                        <div className="grid grid-cols-1 md:grid-cols-3 h-[70vh]">
                                            {/* Left Navigation */}
                                            <div className="bg-gray-50 p-6 border-r">
                                                <h4 className="font-bold mb-4">Quick Help</h4>
                                                <div className="space-y-3">
                                                    <button 
                                                        onClick={() => window.open('UserGuide.html', '_blank')}
                                                        className="w-full text-left p-3 bg-white hover:bg-green-50 rounded-lg border flex items-center"
                                                    >
                                                        <i className="fas fa-book text-green-600 mr-3"></i>
                                                        <div>
                                                            <div className="font-medium">Full User Guide</div>
                                                            <div className="text-xs text-gray-500">Complete documentation</div>
                                                        </div>
                                                    </button>
                                                    
                                                    <button 
                                                        onClick={() => {
                                                            const url = 'https://landcareaustralia.org.au';
                                                            window.open(url, '_blank');
                                                        }}
                                                        className="w-full text-left p-3 bg-white hover:bg-green-50 rounded-lg border flex items-center"
                                                    >
                                                        <i className="fas fa-hands-helping text-green-600 mr-3"></i>
                                                        <div>
                                                            <div className="font-medium">Landcare Australia</div>
                                                            <div className="text-xs text-gray-500">National support network</div>
                                                        </div>
                                                    </button>
                                                    
                                                    <button 
                                                        onClick={() => {
                                                            const url = `https://www.google.com/search?q=${encodeURIComponent(formData.property.state || '')}+NRM+officer+contact`;
                                                            window.open(url, '_blank');
                                                        }}
                                                        className="w-full text-left p-3 bg-white hover:bg-green-50 rounded-lg border flex items-center"
                                                    >
                                                        <i className="fas fa-user-tie text-blue-600 mr-3"></i>
                                                        <div>
                                                            <div className="font-medium">Find NRM Officer</div>
                                                            <div className="text-xs text-gray-500">{formData.property.state || 'Your state'}</div>
                                                        </div>
                                                    </button>
                                                </div>
                                                
                                                <div className="mt-8">
                                                    <h4 className="font-bold mb-3">Contact Support</h4>
                                                    <div className="space-y-2 text-sm">
                                                        <div className="flex items-center">
                                                            <i className="fas fa-envelope text-gray-400 mr-2"></i>
                                                            <span>support@leappro.au</span>
                                                        </div>
                                                        <div className="flex items-center">
                                                            <i className="fas fa-phone text-gray-400 mr-2"></i>
                                                            <span>1800 123 456</span>
                                                        </div>
                                                        <div className="flex items-center">
                                                            <i className="fas fa-clock text-gray-400 mr-2"></i>
                                                            <span>Mon-Fri 9am-5pm AEST</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            {/* Main Content */}
                                            <div className="col-span-2 p-6 overflow-y-auto">
                                                <div className="space-y-6">
                                                    {/* Current Step Help */}
                                                    <div className="p-4 bg-blue-50 rounded-lg">
                                                        <h4 className="font-bold mb-2 flex items-center">
                                                            <i className="fas fa-map-marker-alt text-blue-600 mr-2"></i>
                                                            Help with Current Step
                                                        </h4>
                                                        <p className="text-sm text-gray-700">
                                                            You're currently on: <span className="font-semibold">{steps[currentStep].title}</span>
                                                        </p>
                                                        <p className="text-sm text-gray-600 mt-1">
                                                            {getStepHelpContent(currentStep)}
                                                        </p>
                                                    </div>
                                                    
                                                    {/* Video Tutorials */}
                                                    <div>
                                                        <h4 className="font-bold mb-3">Video Tutorials</h4>
                                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                            <div 
                                                                className="p-4 border rounded-lg hover:bg-gray-50 cursor-pointer"
                                                                onClick={() => window.open('https://youtube.com', '_blank')}
                                                            >
                                                                <div className="flex items-center mb-2">
                                                                    <i className="fas fa-play-circle text-red-500 mr-2"></i>
                                                                    <span className="font-medium">Getting Started</span>
                                                                </div>
                                                                <p className="text-xs text-gray-600">5-minute introduction to LEAP Pro</p>
                                                            </div>
                                                            <div 
                                                                className="p-4 border rounded-lg hover:bg-gray-50 cursor-pointer"
                                                                onClick={() => window.open('https://youtube.com', '_blank')}
                                                            >
                                                                <div className="flex items-center mb-2">
                                                                    <i className="fas fa-map-marked-alt text-green-500 mr-2"></i>
                                                                    <span className="font-medium">Mapping Tutorial</span>
                                                                </div>
                                                                <p className="text-xs text-gray-600">Learn to use the mapping tools</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    {/* FAQ */}
                                                    <div>
                                                        <h4 className="font-bold mb-3">Frequently Asked Questions</h4>
                                                        <div className="space-y-3">
                                                            <div className="accordion-item">
                                                                <div className="accordion-header">
                                                                    <span>How do I save my progress?</span>
                                                                    <i className="fas fa-chevron-down"></i>
                                                                </div>
                                                                <div className="accordion-content">
                                                                    <p className="text-sm">Your progress is automatically saved as you work. You can also use the "Save Draft" button in the bottom navigation, or export your data from the Export panel.</p>
                                                                </div>
                                                            </div>
                                                            
                                                            <div className="accordion-item">
                                                                <div className="accordion-header">
                                                                    <span>Can I edit my plan after exporting?</span>
                                                                    <i className="fas fa-chevron-down"></i>
                                                                </div>
                                                                <div className="accordion-content">
                                                                    <p className="text-sm">Yes! Simply continue working in LEAP Pro - your data remains in the application. You can regenerate the PDF at any time with updated information.</p>
                                                                </div>
                                                            </div>
                                                            
                                                            <div className="accordion-item">
                                                                <div className="accordion-header">
                                                                    <span>Is my data private?</span>
                                                                    <i className="fas fa-chevron-down"></i>
                                                                </div>
                                                                <div className="accordion-content">
                                                                    <p className="text-sm">All data is stored locally in your browser. Nothing is uploaded to servers unless you explicitly choose to share it. You can clear all data at any time from Settings.</p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Quick Tips */}
                                                    <div className="p-4 bg-green-50 rounded-lg">
                                                        <h4 className="font-bold mb-2">Quick Tips</h4>
                                                        <ul className="text-sm text-gray-700 space-y-1">
                                                            <li><i className="fas fa-check text-green-500 mr-2"></i>Use templates to get started quickly</li>
                                                            <li><i className="fas fa-check text-green-500 mr-2"></i>Add photos to document site conditions</li>
                                                            <li><i className="fas fa-check text-green-500 mr-2"></i>Review funding opportunities in your state</li>
                                                            <li><i className="fas fa-check text-green-500 mr-2"></i>Export your plan before clearing data</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {/* Settings Modal */}
                        {activeModal === 'settings' && (
                            <div className="modal-overlay" onClick={() => setActiveModal(null)}>
                                <div className="modal-content" onClick={e => e.stopPropagation()}>
                                    <div className="p-6">
                                        <div className="flex justify-between items-center mb-6">
                                            <h3 className="text-xl font-bold">Settings</h3>
                                            <button 
                                                onClick={() => setActiveModal(null)}
                                                className="text-gray-400 hover:text-gray-600"
                                            >
                                                <i className="fas fa-times text-xl"></i>
                                            </button>
                                        </div>
                                        
                                        <div className="space-y-6">
                                            <div>
                                                <h4 className="font-medium mb-3">Data Management</h4>
                                                <button 
                                                    onClick={clearLocalStorage}
                                                    className="w-full text-left p-3 bg-red-50 hover:bg-red-100 rounded-lg text-red-700"
                                                >
                                                    <i className="fas fa-trash mr-2"></i>
                                                    Clear All Data and Start Fresh
                                                </button>
                                            </div>
                                            
                                            <div>
                                                <h4 className="font-medium mb-3">Export Settings</h4>
                                                <div className="space-y-2">
                                                    <label className="flex items-center">
                                                        <input type="checkbox" className="mr-2" defaultChecked />
                                                        Include high-resolution maps
                                                    </label>
                                                    <label className="flex items-center">
                                                        <input type="checkbox" className="mr-2" defaultChecked />
                                                        Include photos in PDF
                                                    </label>
                                                    <label className="flex items-center">
                                                        <input type="checkbox" className="mr-2" />
                                                        Include detailed cost estimates
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {/* Floating Action Button */}
                        {currentStep > 0 && currentStep < steps.length - 1 && (
                            <div className="floating-action-btn" onClick={() => setActiveModal('quickActions')}>
                                <i className="fas fa-bolt text-xl"></i>
                            </div>
                        )}
                        
                        {/* Quick Actions Modal */}
                        {activeModal === 'quickActions' && (
                            <div className="modal-overlay" onClick={() => setActiveModal(null)}>
                                <div className="modal-content max-w-md" onClick={e => e.stopPropagation()}>
                                    <div className="p-6">
                                        <div className="flex justify-between items-center mb-6">
                                            <h3 className="text-xl font-bold">Quick Actions</h3>
                                            <button 
                                                onClick={() => setActiveModal(null)}
                                                className="text-gray-400 hover:text-gray-600"
                                            >
                                                <i className="fas fa-times text-xl"></i>
                                            </button>
                                        </div>
                                        
                                        <div className="grid grid-cols-2 gap-3">
                                            <button 
                                                onClick={() => {
                                                    setActiveModal(null);
                                                    // Trigger file input for photo upload
                                                    const fileInput = document.createElement('input');
                                                    fileInput.type = 'file';
                                                    fileInput.accept = 'image/*';
                                                    fileInput.multiple = true;
                                                    fileInput.onchange = (e) => {
                                                        const files = e.target.files;
                                                        if (files && files.length > 0) {
                                                            alert(`Would upload ${files.length} photo(s). In full implementation, this would trigger photo upload.`);
                                                        }
                                                    };
                                                    fileInput.click();
                                                }}
                                                className="p-4 bg-blue-50 hover:bg-blue-100 rounded-lg text-center cursor-pointer"
                                            >
                                                <i className="fas fa-camera text-blue-600 text-xl mb-2"></i>
                                                <div className="font-medium">Add Photo</div>
                                            </button>
                                            
                                            <button 
                                                onClick={() => {
                                                    setActiveModal(null);
                                                    alert('Map drawing mode would be activated. Navigate to the Mapping step to use this feature.');
                                                }}
                                                className="p-4 bg-green-50 hover:bg-green-100 rounded-lg text-center cursor-pointer"
                                            >
                                                <i className="fas fa-map-marker-alt text-green-600 text-xl mb-2"></i>
                                                <div className="font-medium">Mark Zone</div>
                                            </button>
                                            
                                            <button 
                                                onClick={() => {
                                                    setActiveModal(null);
                                                    const note = prompt('Enter your note:');
                                                    if (note) {
                                                        alert(`Note saved: "${note}"`);
                                                    }
                                                }}
                                                className="p-4 bg-yellow-50 hover:bg-yellow-100 rounded-lg text-center cursor-pointer"
                                            >
                                                <i className="fas fa-sticky-note text-yellow-600 text-xl mb-2"></i>
                                                <div className="font-medium">Add Note</div>
                                            </button>
                                            
                                            <button 
                                                onClick={() => {
                                                    setActiveModal(null);
                                                    setShowHelp(true);
                                                }}
                                                className="p-4 bg-purple-50 hover:bg-purple-100 rounded-lg text-center cursor-pointer"
                                            >
                                                <i className="fas fa-question-circle text-purple-600 text-xl mb-2"></i>
                                                <div className="font-medium">Get Help</div>
                                            </button>
                                        </div>
                                        
                                        <div className="mt-6 p-3 bg-gray-50 rounded-lg">
                                            <p className="text-sm text-gray-600">
                                                <i className="fas fa-info-circle mr-1"></i>
                                                Quick actions allow you to perform common tasks without leaving your current step.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </AppContext.Provider>
            );
        }

        // Dashboard Component
        function Dashboard({ formData, nextStep, clearLocalStorage }) {
            const stats = {
                zones: formData.mapZones.length,
                issues: Object.values(formData.problems).filter(p => p.present || Array.isArray(p) && p.length > 0).length,
                recommendations: formData.recommendations.length,
                photos: formData.photos.length
            };
            
            return (
                <div className="max-w-6xl mx-auto">
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        {/* Left Column - Welcome & Quick Actions */}
                        <div className="lg:col-span-2">
                            <div className="splash-container text-white p-8 mb-8">
                                <h2 className="text-3xl font-bold mb-4">Welcome to LEAP Pro</h2>
                                <p className="text-lg mb-6 opacity-90">Create a comprehensive environmental action plan for your property with our step-by-step guidance.</p>
                                
                                <div className="flex flex-wrap gap-4">
                                    <button onClick={nextStep} className="btn-primary">
                                        <i className="fas fa-play mr-2"></i>
                                        Start New Plan
                                    </button>
                                    <button 
                                        onClick={() => {
                                            if (formData.property.name) {
                                                nextStep();
                                            } else {
                                                alert("Please start a new plan first");
                                            }
                                        }}
                                        className="bg-white text-green-700 px-6 py-3 rounded-lg font-medium hover:bg-gray-50"
                                    >
                                        <i className="fas fa-file-import mr-2"></i>
                                        Continue Existing Plan
                                    </button>
                                </div>
                            </div>
                            
                            {/* Quick Stats */}
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                                <div className="stat-card">
                                    <div className="stat-icon">
                                        <i className="fas fa-map"></i>
                                    </div>
                                    <div>
                                        <div className="text-2xl font-bold">{stats.zones}</div>
                                        <div className="text-gray-600">Mapped Zones</div>
                                    </div>
                                </div>
                                <div className="stat-card">
                                    <div className="stat-icon">
                                        <i className="fas fa-exclamation-triangle"></i>
                                    </div>
                                    <div>
                                        <div className="text-2xl font-bold">{stats.issues}</div>
                                        <div className="text-gray-600">Issues Identified</div>
                                    </div>
                                </div>
                                <div className="stat-card">
                                    <div className="stat-icon">
                                        <i className="fas fa-lightbulb"></i>
                                    </div>
                                    <div>
                                        <div className="text-2xl font-bold">{stats.recommendations}</div>
                                        <div className="text-gray-600">Recommendations</div>
                                    </div>
                                </div>
                                <div className="stat-card">
                                    <div className="stat-icon">
                                        <i className="fas fa-camera"></i>
                                    </div>
                                    <div>
                                        <div className="text-2xl font-bold">{stats.photos}</div>
                                        <div className="text-gray-600">Site Photos</div>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Recent Activity */}
                            <div className="card mb-8">
                                <h3 className="text-xl font-bold mb-4">Recent Activity</h3>
                                {formData.property.name ? (
                                    <div className="space-y-4">
                                        <div className="flex items-center p-3 bg-gray-50 rounded-lg">
                                            <div className="bg-green-100 p-2 rounded-lg mr-3">
                                                <i className="fas fa-home text-green-600"></i>
                                            </div>
                                            <div>
                                                <div className="font-medium">Property Profile Created</div>
                                                <div className="text-sm text-gray-600">{formData.property.name}</div>
                                            </div>
                                        </div>
                                        {stats.zones > 0 && (
                                            <div className="flex items-center p-3 bg-gray-50 rounded-lg">
                                                <div className="bg-blue-100 p-2 rounded-lg mr-3">
                                                    <i className="fas fa-map-marked-alt text-blue-600"></i>
                                                </div>
                                                <div>
                                                    <div className="font-medium">Zones Mapped</div>
                                                    <div className="text-sm text-gray-600">{stats.zones} areas identified</div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    <p className="text-gray-500 p-4 text-center">No activity yet. Start your first plan!</p>
                                )}
                            </div>
                        </div>
                        
                        {/* Right Column - Templates & Resources */}
                        <div>
                            <div className="card mb-6">
                                <h3 className="text-xl font-bold mb-4">Quick Start Templates</h3>
                                <div className="space-y-3">
                                    <button onClick={nextStep} className="w-full text-left p-4 bg-green-50 hover:bg-green-100 rounded-lg border border-green-200">
                                        <div className="font-medium mb-1">Landcare Group Template</div>
                                        <div className="text-sm text-gray-600">Focus on biodiversity and community projects</div>
                                    </button>
                                    <button onClick={nextStep} className="w-full text-left p-4 bg-blue-50 hover:bg-blue-100 rounded-lg border border-blue-200">
                                        <div className="font-medium mb-1">Council Compliance Template</div>
                                        <div className="text-sm text-gray-600">Meeting local government requirements</div>
                                    </button>
                                    <button onClick={nextStep} className="w-full text-left p-4 bg-purple-50 hover:bg-purple-100 rounded-lg border border-purple-200">
                                        <div className="font-medium mb-1">Farm Sustainability Template</div>
                                        <div className="text-sm text-gray-600">Balancing production and conservation</div>
                                    </button>
                                </div>
                            </div>
                            
                            <div className="card">
                                <h3 className="text-xl font-bold mb-4">Resources & Support</h3>
                                <div className="space-y-4">
                                    <div className="flex items-center p-3 hover:bg-gray-50 rounded-lg cursor-pointer" onClick={() => window.open('https://leappro.au/guide', '_blank')}>
                                        <div className="bg-gray-100 p-2 rounded-lg mr-3">
                                            <i className="fas fa-file-pdf text-red-500"></i>
                                        </div>
                                        <div>
                                            <div className="font-medium">User Guide (PDF)</div>
                                            <div className="text-sm text-gray-600">Complete documentation</div>
                                        </div>
                                    </div>
                                    <div className="flex items-center p-3 hover:bg-gray-50 rounded-lg cursor-pointer" onClick={() => window.open('https://youtube.com', '_blank')}>
                                        <div className="bg-gray-100 p-2 rounded-lg mr-3">
                                            <i className="fas fa-video text-blue-500"></i>
                                        </div>
                                        <div>
                                            <div className="font-medium">Video Tutorials</div>
                                            <div className="text-sm text-gray-600">Step-by-step guides</div>
                                        </div>
                                    </div>
                                    <div className="flex items-center p-3 hover:bg-gray-50 rounded-lg cursor-pointer" onClick={() => window.open('https://landcareaustralia.org.au', '_blank')}>
                                        <div className="bg-gray-100 p-2 rounded-lg mr-3">
                                            <i className="fas fa-phone-alt text-green-500"></i>
                                        </div>
                                        <div>
                                            <div className="font-medium">Support Contacts</div>
                                            <div className="text-sm text-gray-600">Local NRM officers</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Property Form Component
        function PropertyForm({ data, update, sampleWeeds }) {
            const [localData, setLocalData] = useState(data);
            
            const propertyFeatures = [
                'Creeks or rivers', 'Native vegetation', 'Wetlands', 'Rocky outcrops',
                'Existing fencing', 'Farm infrastructure', 'Pasture areas', 'Forest/woodland',
                'Cropping areas', 'Dam/s', 'Stockyards', 'Access roads'
            ];
            
            const vegetationTypes = [
                'Native grassland', 'Woodland', 'Forest', 'Wetland', 'Riparian',
                'Plantation', 'Pasture', 'Cropping', 'Revegetation area', 'Bare ground'
            ];
            
            const handleChange = (e) => {
                const { name, value, type, checked } = e.target;
                setLocalData(prev => ({
                    ...prev,
                    [name]: type === 'checkbox' ? checked : value
                }));
            };
            
            const handleFeatureToggle = (feature) => {
                setLocalData(prev => {
                    const newFeatures = prev.features.includes(feature)
                        ? prev.features.filter(f => f !== feature)
                        : [...prev.features, feature];
                    return { ...prev, features: newFeatures };
                });
            };
            
            const handleVegetationToggle = (veg) => {
                setLocalData(prev => {
                    const newVeg = prev.vegetation.includes(veg)
                        ? prev.vegetation.filter(v => v !== veg)
                        : [...prev.vegetation, veg];
                    return { ...prev, vegetation: newVeg };
                });
            };
            
            useEffect(() => {
                update(localData);
            }, [localData]);
            
            return (
                <div className="max-w-4xl mx-auto">
                    <div className="flex justify-between items-center mb-8">
                        <div>
                            <h2 className="text-2xl font-bold text-gray-800">Property Profile</h2>
                            <p className="text-gray-600">Tell us about your property's characteristics and features</p>
                        </div>
                        <div className="text-sm text-gray-500">
                            <i className="fas fa-info-circle mr-1"></i>
                            All information is saved automatically
                        </div>
                    </div>
                    
                    <div className="card">
                        <div className="mb-8">
                            <h3 className="text-lg font-bold mb-4 pb-2 border-b">Basic Information</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label className="form-label">
                                        Property Name <span className="text-red-500">*</span>
                                        <span className="tooltip ml-1">?
                                            <span className="tooltip-text">Enter a descriptive name for your property (e.g., "Riverbend Farm")</span>
                                        </span>
                                    </label>
                                    <input
                                        type="text"
                                        name="name"
                                        value={localData.name}
                                        onChange={handleChange}
                                        className="form-input"
                                        placeholder="e.g., Riverbend Farm"
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="form-label">Property Size</label>
                                    <div className="flex">
                                        <input
                                            type="number"
                                            name="size"
                                            value={localData.size}
                                            onChange={handleChange}
                                            className="form-input rounded-r-none"
                                            placeholder="e.g., 50"
                                            min="0"
                                        />
                                        <div className="bg-gray-100 px-4 flex items-center rounded-r-lg border border-l-0 border-gray-300">
                                            hectares
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div className="mb-8">
                            <h3 className="text-lg font-bold mb-4 pb-2 border-b">Location Details</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                <div>
                                    <label className="form-label">Nearest Town/Address</label>
                                    <input
                                        type="text"
                                        name="location"
                                        value={localData.location}
                                        onChange={handleChange}
                                        className="form-input"
                                        placeholder="e.g., Bega, NSW"
                                    />
                                </div>
                                <div>
                                    <label className="form-label">State/Territory</label>
                                    <select
                                        name="state"
                                        value={localData.state}
                                        onChange={handleChange}
                                        className="form-select"
                                    >
                                        <option value="">Select...</option>
                                        <option value="NSW">New South Wales</option>
                                        <option value="VIC">Victoria</option>
                                        <option value="QLD">Queensland</option>
                                        <option value="WA">Western Australia</option>
                                        <option value="SA">South Australia</option>
                                        <option value="TAS">Tasmania</option>
                                        <option value="NT">Northern Territory</option>
                                        <option value="ACT">Australian Capital Territory</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <label className="form-label">Annual Rainfall</label>
                                    <select
                                        name="rainfall"
                                        value={localData.rainfall}
                                        onChange={handleChange}
                                        className="form-select"
                                    >
                                        <option value="">Select...</option>
                                        <option value="<250">Less than 250mm</option>
                                        <option value="250-500">250-500mm</option>
                                        <option value="500-750">500-750mm</option>
                                        <option value="750-1000">750-1000mm</option>
                                        <option value=">1000">More than 1000mm</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="form-label">Dominant Soil Type</label>
                                    <select
                                        name="soilType"
                                        value={localData.soilType}
                                        onChange={handleChange}
                                        className="form-select"
                                    >
                                        <option value="">Select...</option>
                                        <option value="clay">Clay</option>
                                        <option value="sandy">Sandy</option>
                                        <option value="loam">Loam</option>
                                        <option value="rocky">Rocky</option>
                                        <option value="alluvial">Alluvial</option>
                                        <option value="volcanic">Volcanic</option>
                                        <option value="peat">Peat</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="form-label">Elevation Range</label>
                                    <select
                                        name="elevation"
                                        value={localData.elevation}
                                        onChange={handleChange}
                                        className="form-select"
                                    >
                                        <option value="">Select...</option>
                                        <option value="coastal">Coastal (0-100m)</option>
                                        <option value="lowland">Lowland (100-500m)</option>
                                        <option value="upland">Upland (500-1000m)</option>
                                        <option value="mountain">Mountain (1000m+)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div className="mb-8">
                            <h3 className="text-lg font-bold mb-4 pb-2 border-b">Property Features</h3>
                            <div className="mb-6">
                                <label className="form-label mb-3">What features does your property have?</label>
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                    {propertyFeatures.map(feature => (
                                        <div key={feature} className="flex items-start">
                                            <div className="flex items-center h-5">
                                                <input
                                                    type="checkbox"
                                                    id={`feature-${feature}`}
                                                    checked={localData.features.includes(feature)}
                                                    onChange={() => handleFeatureToggle(feature)}
                                                    className="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded"
                                                />
                                            </div>
                                            <label htmlFor={`feature-${feature}`} className="ml-2 block text-sm text-gray-700">
                                                {feature}
                                            </label>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            
                            <div>
                                <label className="form-label mb-3">Vegetation Types Present</label>
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                    {vegetationTypes.map(veg => (
                                        <div key={veg} className="flex items-start">
                                            <div className="flex items-center h-5">
                                                <input
                                                    type="checkbox"
                                                    id={`veg-${veg}`}
                                                    checked={localData.vegetation.includes(veg)}
                                                    onChange={() => handleVegetationToggle(veg)}
                                                    className="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded"
                                                />
                                            </div>
                                            <label htmlFor={`veg-${veg}`} className="ml-2 block text-sm text-gray-700">
                                                {veg}
                                            </label>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                        
                        {localData.state && sampleWeeds[localData.state] && (
                            <div className="p-4 bg-blue-50 rounded-lg border border-blue-200">
                                <h4 className="font-bold mb-2 text-blue-800">
                                    <i className="fas fa-info-circle mr-2"></i>
                                    Common Weeds in {localData.state}
                                </h4>
                                <p className="text-sm text-gray-700 mb-3">These species are commonly found in your region:</p>
                                <div className="flex flex-wrap gap-2">
                                    {sampleWeeds[localData.state].slice(0, 5).map(weed => (
                                        <div key={weed.name} className="bg-white px-3 py-1 rounded-lg border text-sm">
                                            {weed.name}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Assessment Form Component
        function AssessmentForm({ data, update, sampleWeeds, state }) {
            const [localData, setLocalData] = useState(data);
            const [otherWeed, setOtherWeed] = useState('');
            const [otherGoal, setOtherGoal] = useState('');
            
            const managementGoals = [
                'Improve biodiversity', 'Control invasive species', 'Reduce erosion',
                'Improve water quality', 'Enhance farm productivity', 'Create wildlife habitat',
                'Reduce fire risk', 'Carbon sequestration', 'Increase soil health',
                'Meet regulatory requirements', 'Enhance landscape aesthetics',
                'Develop sustainable grazing', 'Protect cultural heritage sites'
            ];
            
            const feralSpecies = [
                'Rabbits', 'Foxes', 'Cats', 'Deer', 'Pigs', 'Goats',
                'Horses', 'Camels', 'Wild dogs', 'Cane toads'
            ];
            
            const handleChange = (e) => {
                const { name, value, type, checked } = e.target;
                
                if (name.includes('.')) {
                    const [parent, child] = name.split('.');
                    setLocalData(prev => ({
                        ...prev,
                        [parent]: {
                            ...prev[parent],
                            [child]: type === 'checkbox' ? checked : value
                        }
                    }));
                } else {
                    setLocalData(prev => ({
                        ...prev,
                        [name]: type === 'checkbox' ? checked : value
                    }));
                }
            };
            
            const handleWeedToggle = (weed) => {
                setLocalData(prev => {
                    const newWeeds = prev.weeds.includes(weed)
                        ? prev.weeds.filter(w => w !== weed)
                        : [...prev.weeds, weed];
                    return { ...prev, weeds: newWeeds };
                });
            };
            
            const addOtherWeed = () => {
                if (otherWeed.trim() && !localData.weeds.includes(otherWeed)) {
                    setLocalData(prev => ({
                        ...prev,
                        weeds: [...prev.weeds, otherWeed]
                    }));
                    setOtherWeed('');
                }
            };
            
            const handleGoalToggle = (goal) => {
                setLocalData(prev => {
                    const newGoals = prev.goals.includes(goal)
                        ? prev.goals.filter(g => g !== goal)
                        : [...prev.goals, goal];
                    return { ...prev, goals: newGoals };
                });
            };
            
            const addOtherGoal = () => {
                if (otherGoal.trim() && !localData.goals.includes(otherGoal)) {
                    setLocalData(prev => ({
                        ...prev,
                        goals: [...prev.goals, otherGoal]
                    }));
                    setOtherGoal('');
                }
            };
            
            const handleFeralToggle = (species) => {
                setLocalData(prev => {
                    const newSpecies = prev.feralAnimals.species.includes(species)
                        ? prev.feralAnimals.species.filter(s => s !== species)
                        : [...prev.feralAnimals.species, species];
                    return {
                        ...prev,
                        feralAnimals: {
                            ...prev.feralAnimals,
                            species: newSpecies
                        }
                    };
                });
            };
            
            useEffect(() => {
                update(localData);
            }, [localData]);
            
            return (
                <div className="max-w-4xl mx-auto">
                    <div className="flex justify-between items-center mb-8">
                        <div>
                            <h2 className="text-2xl font-bold text-gray-800">Property Assessment</h2>
                            <p className="text-gray-600">Identify environmental issues and management goals</p>
                        </div>
                    </div>
                    
                    <div className="space-y-8">
                        {/* Environmental Issues */}
                        <div className="card">
                            <h3 className="text-lg font-bold mb-6 pb-2 border-b">Environmental Issues</h3>
                            
                            <div className="space-y-6">
                                {[
                                    { 
                                        id: 'erosion', 
                                        label: 'Soil Erosion',
                                        description: 'Loss of topsoil through water or wind action',
                                        types: ['Sheet erosion', 'Gully erosion', 'Wind erosion', 'Stream bank erosion']
                                    },
                                    { 
                                        id: 'habitatLoss', 
                                        label: 'Habitat Loss/Degradation',
                                        description: 'Decline in native vegetation or wildlife habitat',
                                        types: ['Clearing', 'Fragmentation', 'Weed invasion', 'Overgrazing']
                                    },
                                    { 
                                        id: 'waterQuality', 
                                        label: 'Water Quality Issues',
                                        description: 'Problems with turbidity, nutrients, or pollution',
                                        types: ['Nutrient runoff', 'Sedimentation', 'Algal blooms', 'Salinity']
                                    },
                                    { 
                                        id: 'fireRisk', 
                                        label: 'Bushfire Risk',
                                        description: 'Areas with high fuel load or near assets',
                                        types: ['Fuel accumulation', 'Asset proximity', 'Access limitations', 'Vegetation type']
                                    },
                                    { 
                                        id: 'salinity', 
                                        label: 'Dryland or Irrigation Salinity',
                                        description: 'Salt accumulation in soil or water',
                                        types: ['Dryland salinity', 'Irrigation salinity', 'Waterlogging']
                                    }
                                ].map(issue => (
                                    <div key={issue.id} className="border-b pb-6 last:border-b-0 last:pb-0">
                                        <div className="flex items-start">
                                            <div className="flex items-center h-5 pt-1">
                                                <input
                                                    type="checkbox"
                                                    id={`${issue.id}-present`}
                                                    name={`${issue.id}.present`}
                                                    checked={localData[issue.id].present}
                                                    onChange={handleChange}
                                                    className="h-5 w-5 text-green-600 focus:ring-green-500 border-gray-300 rounded"
                                                />
                                            </div>
                                            <div className="ml-4 flex-1">
                                                <div className="flex justify-between items-start">
                                                    <div>
                                                        <label htmlFor={`${issue.id}-present`} className="block text-lg font-medium text-gray-800">
                                                            {issue.label}
                                                        </label>
                                                        <p className="text-sm text-gray-600">{issue.description}</p>
                                                    </div>
                                                    {localData[issue.id].present && (
                                                        <div className="text-sm">
                                                            <span className="font-medium">Severity:</span>
                                                            <select
                                                                name={`${issue.id}.severity`}
                                                                value={localData[issue.id].severity}
                                                                onChange={handleChange}
                                                                className="ml-2 px-2 py-1 border rounded"
                                                            >
                                                                <option value="low">Low</option>
                                                                <option value="medium">Medium</option>
                                                                <option value="high">High</option>
                                                            </select>
                                                        </div>
                                                    )}
                                                </div>
                                                
                                                {localData[issue.id].present && (
                                                    <div className="mt-4">
                                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                                            Type of {issue.label}:
                                                        </label>
                                                        <div className="flex flex-wrap gap-2">
                                                            {issue.types.map(type => (
                                                                <button
                                                                    key={type}
                                                                    type="button"
                                                                    onClick={() => setLocalData(prev => ({
                                                                        ...prev,
                                                                        [issue.id]: {
                                                                            ...prev[issue.id],
                                                                            type: prev[issue.id].type === type ? '' : type
                                                                        }
                                                                    }))}
                                                                    className={`px-3 py-1 rounded-full text-sm ${
                                                                        localData[issue.id].type === type
                                                                            ? 'bg-green-100 text-green-800 border border-green-300'
                                                                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                                                    }`}
                                                                >
                                                                    {type}
                                                                </button>
                                                            ))}
                                                        </div>
                                                        
                                                        <div className="mt-4">
                                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                                Additional Notes:
                                                            </label>
                                                            <textarea
                                                                name={`${issue.id}.notes`}
                                                                value={localData[issue.id].notes}
                                                                onChange={handleChange}
                                                                className="w-full p-3 border rounded-lg"
                                                                rows="2"
                                                                placeholder="Describe the issue in more detail..."
                                                            />
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        
                        {/* Weed Problems */}
                        <div className="card">
                            <h3 className="text-lg font-bold mb-6 pb-2 border-b">Weed Problems</h3>
                            
                            <div className="mb-6">
                                <label className="block text-sm font-medium text-gray-700 mb-4">
                                    Select weed species present on your property:
                                </label>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                    {sampleWeeds[state]?.map(weed => (
                                        <div key={weed.name} className="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input
                                                type="checkbox"
                                                id={`weed-${weed.name}`}
                                                checked={localData.weeds.includes(weed.name)}
                                                onChange={() => handleWeedToggle(weed.name)}
                                                className="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded"
                                            />
                                            <label htmlFor={`weed-${weed.name}`} className="ml-3 flex-1">
                                                <div className="font-medium">{weed.name}</div>
                                                <div className="text-xs text-gray-500">Control: {weed.control}</div>
                                            </label>
                                            <span className="text-xs bg-gray-100 px-2 py-1 rounded">
                                                {weed.season}
                                            </span>
                                        </div>
                                    ))}
                                </div>
                                
                                <div className="flex gap-2 mb-4">
                                    <input
                                        type="text"
                                        value={otherWeed}
                                        onChange={(e) => setOtherWeed(e.target.value)}
                                        placeholder="Add other weed species"
                                        className="flex-grow p-3 border rounded-lg"
                                    />
                                    <button 
                                        onClick={addOtherWeed}
                                        className="bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg"
                                    >
                                        Add
                                    </button>
                                </div>
                                
                                {localData.weeds.length > 0 && (
                                    <div className="p-4 bg-green-50 rounded-lg">
                                        <div className="font-medium mb-2">Selected Weeds:</div>
                                        <div className="flex flex-wrap gap-2">
                                            {localData.weeds.map(weed => (
                                                <span key={weed} className="bg-white px-3 py-1 rounded-lg border text-sm flex items-center">
                                                    {weed}
                                                    <button 
                                                        onClick={() => handleWeedToggle(weed)}
                                                        className="ml-2 text-red-500 hover:text-red-700"
                                                    >
                                                        Ã—
                                                    </button>
                                                </span>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                        
                        {/* Feral Animals */}
                        <div className="card">
                            <h3 className="text-lg font-bold mb-6 pb-2 border-b">Feral Animal Problems</h3>
                            
                            <div className="flex items-center mb-4">
                                <input
                                    type="checkbox"
                                    id="feral-present"
                                    checked={localData.feralAnimals.present}
                                    onChange={(e) => setLocalData(prev => ({
                                        ...prev,
                                        feralAnimals: {
                                            ...prev.feralAnimals,
                                            present: e.target.checked
                                        }
                                    }))}
                                    className="h-5 w-5 text-green-600 focus:ring-green-500 border-gray-300 rounded"
                                />
                                <label htmlFor="feral-present" className="ml-3 text-lg font-medium">
                                    Feral animals are a problem on my property
                                </label>
                            </div>
                            
                            {localData.feralAnimals.present && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-3">
                                        Select feral species present:
                                    </label>
                                    <div className="grid grid-cols-2 md:grid-cols-3 gap-3 mb-4">
                                        {feralSpecies.map(species => (
                                            <div key={species} className="flex items-center">
                                                <input
                                                    type="checkbox"
                                                    id={`feral-${species}`}
                                                    checked={localData.feralAnimals.species.includes(species)}
                                                    onChange={() => handleFeralToggle(species)}
                                                    className="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded"
                                                />
                                                <label htmlFor={`feral-${species}`} className="ml-2 text-sm">
                                                    {species}
                                                </label>
                                            </div>
                                        ))}
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Impact Notes:
                                        </label>
                                        <textarea
                                            value={localData.feralAnimals.notes}
                                            onChange={(e) => setLocalData(prev => ({
                                                ...prev,
                                                feralAnimals: {
                                                    ...prev.feralAnimals,
                                                    notes: e.target.value
                                                }
                                            }))}
                                            className="w-full p-3 border rounded-lg"
                                            rows="3"
                                            placeholder="Describe the impacts of feral animals on your property..."
                                        />
                                    </div>
                                </div>
                            )}
                        </div>
                        
                        {/* Management Goals */}
                        <div className="card">
                            <h3 className="text-lg font-bold mb-6 pb-2 border-b">Management Goals</h3>
                            
                            <div className="mb-6">
                                <label className="block text-sm font-medium text-gray-700 mb-4">
                                    What are your main objectives for your property? (Select all that apply)
                                </label>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    {managementGoals.map(goal => (
                                        <div key={goal} className="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                                            <input
                                                type="checkbox"
                                                id={`goal-${goal}`}
                                                checked={localData.goals.includes(goal)}
                                                onChange={() => handleGoalToggle(goal)}
                                                className="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded"
                                            />
                                            <label htmlFor={`goal-${goal}`} className="ml-3">
                                                {goal}
                                            </label>
                                        </div>
                                    ))}
                                </div>
                                
                                <div className="mt-4 flex gap-2">
                                    <input
                                        type="text"
                                        value={otherGoal}
                                        onChange={(e) => setOtherGoal(e.target.value)}
                                        placeholder="Add other goal"
                                        className="flex-grow p-3 border rounded-lg"
                                    />
                                    <button 
                                        onClick={addOtherGoal}
                                        className="bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg"
                                    >
                                        Add
                                    </button>
                                </div>
                            </div>
                            
                            {localData.goals.length > 0 && (
                                <div className="p-4 bg-blue-50 rounded-lg">
                                    <div className="font-medium mb-2">Selected Goals:</div>
                                    <div className="flex flex-wrap gap-2">
                                        {localData.goals.map(goal => (
                                            <span key={goal} className="bg-white px-3 py-1 rounded-lg border border-blue-200 text-sm">
                                                {goal}
                                            </span>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                        
                        {/* Other Concerns */}
                        <div className="card">
                            <h3 className="text-lg font-bold mb-4">Other Environmental Concerns</h3>
                            <textarea
                                name="otherProblems"
                                value={localData.otherProblems}
                                onChange={handleChange}
                                className="w-full p-4 border rounded-lg"
                                rows="4"
                                placeholder="Any other issues, concerns, or observations about your property's environment..."
                            />
                        </div>
                    </div>
                </div>
            );
        }

        // Map Tool Component (Fixed)
        function MapTool({ zones, addZone, updateZone, removeZone, propertyName, location, coordinates, photos, addPhoto, removePhoto }) {
            const mapRef = useRef(null);
            const mapInstance = useRef(null);
            const drawnItemsRef = useRef(null);
            const [zoneName, setZoneName] = useState('');
            const [zoneType, setZoneType] = useState('management');
            const [zoneNotes, setZoneNotes] = useState('');
            const [editingZone, setEditingZone] = useState(null);
            const [photoNotes, setPhotoNotes] = useState('');
            const fileInputRef = useRef(null);
            const [isMapInitialized, setIsMapInitialized] = useState(false);
            const [currentDrawnLayer, setCurrentDrawnLayer] = useState(null);

            // Initialize map
            useEffect(() => {
                if (!isMapInitialized && mapRef.current && window.L) {
                    try {
                        // Remove any existing map instance
                        if (mapRef.current._leaflet_id) {
                            mapInstance.current.remove();
                        }

                        // Create new map instance
                        const map = window.L.map(mapRef.current, {
                            zoomControl: true,
                            attributionControl: true
                        });

                        // Set default view to Australia
                        let defaultCoords = [-28.0, 137.0];
                        let defaultZoom = 4;

                        // Try to use property coordinates if available
                        if (coordinates && coordinates.lat && coordinates.lng) {
                            defaultCoords = [coordinates.lat, coordinates.lng];
                            defaultZoom = 13;
                        }

                        map.setView(defaultCoords, defaultZoom);

                        // Add base layers
                        const streetLayer = window.L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: 'Â© OpenStreetMap contributors',
                            maxZoom: 19
                        }).addTo(map);

                        const satelliteLayer = window.L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                            attribution: 'Â© Esri',
                            maxZoom: 19
                        });

                        const topoLayer = window.L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                            attribution: 'Â© OpenTopoMap',
                            maxZoom: 17
                        });

                        // Add layer control
                        const baseLayers = {
                            'Street Map': streetLayer,
                            'Satellite View': satelliteLayer,
                            'Topographic Map': topoLayer
                        };

                        window.L.control.layers(baseLayers, null, { collapsed: false }).addTo(map);

                        // Add locate control
                        window.L.control.locate({
                            position: 'topleft',
                            strings: {
                                title: "Show my location"
                            }
                        }).addTo(map);

                        // Initialize drawn items
                        const drawnItems = new window.L.FeatureGroup();
                        map.addLayer(drawnItems);
                        drawnItemsRef.current = drawnItems;

                        // Add draw control
                        const drawControl = new window.L.Control.Draw({
                            position: 'topright',
                            edit: {
                                featureGroup: drawnItems,
                                remove: true,
                                edit: true
                            },
                            draw: {
                                polygon: {
                                    allowIntersection: false,
                                    showArea: true,
                                    shapeOptions: {
                                        color: getZoneColor(zoneType),
                                        fillColor: getZoneColor(zoneType),
                                        fillOpacity: 0.2,
                                        weight: 3
                                    }
                                },
                                polyline: false,
                                rectangle: {
                                    showArea: true,
                                    shapeOptions: {
                                        color: getZoneColor(zoneType),
                                        fillColor: getZoneColor(zoneType),
                                        fillOpacity: 0.2,
                                        weight: 3
                                    }
                                },
                                circle: false,
                                marker: {
                                    icon: window.L.divIcon({
                                        className: 'custom-marker',
                                        html: `<div style="background-color: ${getZoneColor(zoneType)}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                                        iconSize: [24, 24],
                                        iconAnchor: [12, 24]
                                    })
                                }
                            }
                        });

                        map.addControl(drawControl);

                        // Handle draw created event
                        map.on('draw:created', function (e) {
                            const layer = e.layer;
                            const type = e.layerType;
                            
                            // Store the layer reference
                            setCurrentDrawnLayer(layer);
                            
                            // Add to drawn items
                            drawnItems.addLayer(layer);
                            
                            // Auto-generate zone name
                            const typeNames = {
                                'management': 'Management Area',
                                'problem': 'Problem Area',
                                'sensitive': 'Sensitive Area',
                                'other': 'Other Area'
                            };
                            
                            const newZoneName = `${typeNames[zoneType]} ${zones.length + 1}`;
                            setZoneName(newZoneName);
                            
                            // Bind popup to the layer
                            const tempId = Date.now();
                            layer.zoneId = tempId;
                            layer.zoneType = zoneType;
                            
                            bindPopupToLayer(layer, {
                                name: newZoneName,
                                type: zoneType,
                                notes: zoneNotes,
                                id: tempId
                            });
                            
                            // Fit bounds to show all layers
                            if (drawnItems.getLayers().length > 0) {
                                map.fitBounds(drawnItems.getBounds());
                            }
                        });

                        // Handle draw edited event
                        map.on('draw:edited', function (e) {
                            const layers = e.layers;
                            layers.eachLayer(function (layer) {
                                // Update the coordinates for the corresponding zone
                                const zoneId = layer.zoneId;
                                if (zoneId) {
                                    const newCoordinates = extractCoordinatesFromLayer(layer);
                                    const zone = zones.find(z => z.id === zoneId);
                                    if (zone) {
                                        updateZone(zoneId, { coordinates: newCoordinates });
                                    }
                                }
                            });
                        });

                        // Handle draw deleted event
                        map.on('draw:deleted', function (e) {
                            const layers = e.layers;
                            layers.eachLayer(function (layer) {
                                const zoneId = layer.zoneId;
                                if (zoneId) {
                                    removeZone(zoneId);
                                }
                            });
                        });

                        mapInstance.current = map;
                        setIsMapInitialized(true);

                    } catch (error) {
                        console.error('Error initializing map:', error);
                        setIsMapInitialized(false);
                    }
                }

                return () => {
                    if (mapInstance.current) {
                        mapInstance.current.remove();
                        mapInstance.current = null;
                    }
                };
            }, []);

            // Helper function to bind popup to layer
            const bindPopupToLayer = (layer, zoneData) => {
                layer.bindPopup(`
                    <div class="p-3" style="min-width: 200px;">
                        <h4 class="font-bold text-lg mb-2">${zoneData.name}</h4>
                        <div class="mb-2">
                            <span class="inline-block px-2 py-1 text-xs rounded-full ${getZoneStyleClass(zoneData.type)}">
                                ${zoneData.type}
                            </span>
                        </div>
                        ${zoneData.notes ? `<p class="text-sm mb-3">${zoneData.notes}</p>` : ''}
                        <div class="flex space-x-2">
                            <button onclick="window.editZoneHandler && window.editZoneHandler(${zoneData.id})" 
                                    class="flex-1 px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white text-sm rounded">
                                Edit
                            </button>
                            <button onclick="window.deleteZoneHandler && window.deleteZoneHandler(${zoneData.id})" 
                                    class="flex-1 px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-sm rounded">
                                Delete
                            </button>
                        </div>
                    </div>
                `);
            };

            // Set up global handlers for popup buttons
            useEffect(() => {
                window.editZoneHandler = (zoneId) => {
                    const zone = zones.find(z => z.id === zoneId);
                    if (zone) {
                        setEditingZone(zoneId);
                        setZoneName(zone.name);
                        setZoneType(zone.type);
                        setZoneNotes(zone.notes || '');
                        
                        // If there's a map instance, highlight the zone
                        if (mapInstance.current && drawnItemsRef.current) {
                            drawnItemsRef.current.eachLayer((layer) => {
                                if (layer.zoneId === zoneId) {
                                    mapInstance.current.fitBounds(layer.getBounds());
                                    layer.setStyle({ weight: 5, color: '#FFD700' }); // Highlight in gold
                                    setTimeout(() => {
                                        layer.setStyle({ weight: 3, color: getZoneColor(zone.type) });
                                    }, 3000);
                                }
                            });
                        }
                    }
                };

                window.deleteZoneHandler = (zoneId) => {
                    if (confirm('Are you sure you want to delete this zone?')) {
                        removeZone(zoneId);
                        
                        // Also remove from map
                        if (drawnItemsRef.current) {
                            drawnItemsRef.current.eachLayer((layer) => {
                                if (layer.zoneId === zoneId) {
                                    drawnItemsRef.current.removeLayer(layer);
                                }
                            });
                        }
                    }
                };

                return () => {
                    delete window.editZoneHandler;
                    delete window.deleteZoneHandler;
                };
            }, [zones]);

            // Update drawn items when zones change
            useEffect(() => {
                if (isMapInitialized && mapInstance.current && drawnItemsRef.current) {
                    try {
                        // Clear existing layers
                        drawnItemsRef.current.clearLayers();
                        
                        zones.forEach((zone) => {
                            let layer = null;
                            const color = getZoneColor(zone.type);
                            
                            if (zone.coordinates) {
                                layer = createLayerFromCoordinates(zone.coordinates, color);
                            }
                            
                            if (layer) {
                                layer.zoneId = zone.id;
                                layer.zoneType = zone.type;
                                
                                // Bind popup
                                bindPopupToLayer(layer, zone);
                                
                                // Add to map
                                drawnItemsRef.current.addLayer(layer);
                            }
                        });
                        
                        // Fit bounds to show all zones
                        if (zones.length > 0 && drawnItemsRef.current.getLayers().length > 0) {
                            const bounds = drawnItemsRef.current.getBounds();
                            if (bounds.isValid()) {
                                mapInstance.current.fitBounds(bounds, { padding: [50, 50] });
                            }
                        }
                        
                    } catch (error) {
                        console.error('Error updating zones on map:', error);
                    }
                }
            }, [zones, isMapInitialized]);

            // Helper functions
            const getZoneColor = (type) => {
                const colors = {
                    management: '#2196F3',
                    problem: '#f44336',
                    sensitive: '#4CAF50',
                    other: '#ff9800'
                };
                return colors[type] || '#2196F3';
            };

            const getZoneStyleClass = (type) => {
                const classes = {
                    management: 'bg-blue-100 text-blue-800',
                    problem: 'bg-red-100 text-red-800',
                    sensitive: 'bg-green-100 text-green-800',
                    other: 'bg-orange-100 text-orange-800'
                };
                return classes[type] || 'bg-gray-100 text-gray-800';
            };

            const extractCoordinatesFromLayer = (layer) => {
                if (layer instanceof window.L.Marker) {
                    const latLng = layer.getLatLng();
                    return {
                        type: 'Point',
                        coordinates: [latLng.lng, latLng.lat]
                    };
                } else if (layer instanceof window.L.Polygon || layer instanceof window.L.Rectangle) {
                    const latLngs = layer.getLatLngs();
                    // Handle both Polygon (array of arrays) and Rectangle (array)
                    let coordinates;
                    if (layer instanceof window.L.Polygon) {
                        coordinates = latLngs[0]; // For polygons, latLngs[0] contains the outer ring
                    } else {
                        coordinates = latLngs; // For rectangles, latLngs is the array
                    }
                    
                    return {
                        type: 'Polygon',
                        coordinates: [coordinates.map(latLng => [latLng.lng, latLng.lat])]
                    };
                }
                return null;
            };

            const createLayerFromCoordinates = (coordinates, color) => {
                if (!coordinates) return null;
                
                try {
                    if (coordinates.type === 'Point') {
                        const [lng, lat] = coordinates.coordinates;
                        const marker = window.L.marker([lat, lng], {
                            icon: window.L.divIcon({
                                className: 'custom-marker',
                                html: `<div style="background-color: ${color}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                                iconSize: [24, 24],
                                iconAnchor: [12, 24]
                            })
                        });
                        return marker;
                    } else if (coordinates.type === 'Polygon') {
                        const latLngs = coordinates.coordinates[0].map(coord => [coord[1], coord[0]]);
                        const polygon = window.L.polygon(latLngs, {
                            color: color,
                            fillColor: color,
                            fillOpacity: 0.2,
                            weight: 3
                        });
                        return polygon;
                    }
                } catch (error) {
                    console.error('Error creating layer from coordinates:', error);
                }
                return null;
            };

            const saveZone = () => {
                if (!zoneName.trim()) {
                    alert('Please provide a zone name');
                    return;
                }

                let zoneCoordinates = null;
                
                // Get coordinates from current drawn layer if available
                if (currentDrawnLayer) {
                    zoneCoordinates = extractCoordinatesFromLayer(currentDrawnLayer);
                }
                
                // If no drawn layer, create a default polygon
                if (!zoneCoordinates) {
                    // Use a small polygon in central Australia as default
                    zoneCoordinates = {
                        type: 'Polygon',
                        coordinates: [[
                            [137.0, -28.0],
                            [137.1, -28.0],
                            [137.1, -28.1],
                            [137.0, -28.1],
                            [137.0, -28.0]
                        ]]
                    };
                }

                if (editingZone !== null) {
                    // Update existing zone
                    updateZone(editingZone, {
                        name: zoneName,
                        type: zoneType,
                        notes: zoneNotes,
                        coordinates: zoneCoordinates
                    });
                    setEditingZone(null);
                } else {
                    // Create new zone
                    const newZone = {
                        id: Date.now(),
                        name: zoneName,
                        type: zoneType,
                        notes: zoneNotes,
                        coordinates: zoneCoordinates,
                        dateAdded: new Date().toISOString()
                    };
                    
                    addZone(newZone);
                }

                // Reset form
                setZoneName('');
                setZoneType('management');
                setZoneNotes('');
                setCurrentDrawnLayer(null);
            };

            // Handle file upload for photos
            const handleFileChange = (e) => {
                const files = e.target.files;
                if (!files || files.length === 0) return;

                Array.from(files).forEach(file => {
                    if (!file.type.startsWith('image/')) {
                        alert(`File ${file.name} is not an image`);
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (event) => {
                        addPhoto({
                            url: event.target.result,
                            notes: photoNotes || `Photo from ${new Date().toLocaleDateString()}`,
                            filename: file.name,
                            date: new Date().toISOString(),
                            size: file.size
                        });
                    };
                    reader.onerror = (error) => {
                        console.error('Error reading file:', error);
                        alert(`Error reading file ${file.name}`);
                    };
                    reader.readAsDataURL(file);
                });
                
                setPhotoNotes('');
                e.target.value = '';
            };

            // Handle search for location
            const handleSearchLocation = () => {
                if (!mapInstance.current) return;
                
                const searchQuery = prompt('Enter location to search (address, town, etc.):');
                if (!searchQuery) return;
                
                // Simple geocoding using Nominatim
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=1`)
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.length > 0) {
                            const result = data[0];
                            const lat = parseFloat(result.lat);
                            const lon = parseFloat(result.lon);
                            
                            mapInstance.current.setView([lat, lon], 13);
                            
                            // Add marker
                            const marker = window.L.marker([lat, lon]).addTo(mapInstance.current);
                            marker.bindPopup(`<b>${result.display_name}</b>`).openPopup();
                            
                        } else {
                            alert('Location not found. Please try a different search.');
                        }
                    })
                    .catch(error => {
                        console.error('Geocoding error:', error);
                        alert('Error searching for location. Please try again.');
                    });
            };

            return (
                <div className="max-w-6xl mx-auto">
                    <div className="flex justify-between items-center mb-8">
                        <div>
                            <h2 className="text-2xl font-bold text-gray-800">Property Mapping</h2>
                            <p className="text-gray-600">Map your property features, problem areas, and management zones</p>
                        </div>
                        <div className="text-sm text-gray-500">
                            <i className="fas fa-info-circle mr-1"></i>
                            Draw on map â†’ Fill details â†’ Click "Add Zone"
                        </div>
                    </div>
                    
                    <div className="card">
                        {/* Zone Creation Form */}
                        <div className="mb-6">
                            <h3 className="text-lg font-bold mb-4">Create Zone</h3>
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                                <div className="md:col-span-2">
                                    <label className="form-label">Zone Name *</label>
                                    <input
                                        type="text"
                                        value={zoneName}
                                        onChange={(e) => setZoneName(e.target.value)}
                                        className="form-input"
                                        placeholder="e.g., North Paddock Weeds"
                                    />
                                </div>
                                <div>
                                    <label className="form-label">Zone Type</label>
                                    <select
                                        value={zoneType}
                                        onChange={(e) => setZoneType(e.target.value)}
                                        className="form-select"
                                    >
                                        <option value="management">Management Area</option>
                                        <option value="problem">Problem Area</option>
                                        <option value="sensitive">Sensitive Area</option>
                                        <option value="other">Other Area</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="form-label">Actions</label>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={saveZone}
                                            className="flex-1 btn-primary py-2"
                                        >
                                            {editingZone !== null ? 'Update Zone' : 'Add Zone'}
                                        </button>
                                        {editingZone !== null && (
                                            <button
                                                onClick={() => {
                                                    setEditingZone(null);
                                                    setZoneName('');
                                                    setZoneType('management');
                                                    setZoneNotes('');
                                                    setCurrentDrawnLayer(null);
                                                }}
                                                className="px-3 py-2 border rounded-lg"
                                            >
                                                Cancel
                                            </button>
                                        )}
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label className="form-label">Zone Notes</label>
                                <textarea
                                    value={zoneNotes}
                                    onChange={(e) => setZoneNotes(e.target.value)}
                                    className="form-input"
                                    rows="2"
                                    placeholder="Add notes about this zone..."
                                />
                            </div>
                        </div>
                        
                        {/* Map Container */}
                        <div className="mb-6">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="font-bold">Interactive Map</h3>
                                <div className="flex gap-2">
                                    <button
                                        onClick={handleSearchLocation}
                                        className="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm"
                                    >
                                        <i className="fas fa-search mr-1"></i>
                                        Search Location
                                    </button>
                                    <button
                                        onClick={() => {
                                            if (mapInstance.current) {
                                                mapInstance.current.locate({setView: true, maxZoom: 16});
                                            }
                                        }}
                                        className="px-3 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg text-sm"
                                    >
                                        <i className="fas fa-location-arrow mr-1"></i>
                                        My Location
                                    </button>
                                </div>
                            </div>
                            
                            <div 
                                ref={mapRef} 
                                id="map" 
                                className="w-full"
                                style={{ height: '500px', borderRadius: '8px' }}
                            ></div>
                            
                            <div className="text-sm text-gray-500 mt-2 flex items-center">
                                <i className="fas fa-info-circle mr-2"></i>
                                Use drawing tools (top-right of map) to create zones. Click on zones to edit/delete.
                            </div>
                        </div>
                        
                        {/* Zone Legend */}
                        <div className="mb-8">
                            <h4 className="font-bold mb-3">Zone Legend</h4>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                {[
                                    { type: 'management', label: 'Management Area', color: '#2196F3' },
                                    { type: 'problem', label: 'Problem Area', color: '#f44336' },
                                    { type: 'sensitive', label: 'Sensitive Area', color: '#4CAF50' },
                                    { type: 'other', label: 'Other Area', color: '#ff9800' }
                                ].map(item => (
                                    <div key={item.type} className="flex items-center p-2 bg-gray-50 rounded-lg">
                                        <div 
                                            className="w-6 h-6 mr-3 rounded"
                                            style={{ 
                                                backgroundColor: item.color,
                                                border: `2px solid ${item.color}`
                                            }}
                                        ></div>
                                        <span className="font-medium">{item.label}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                                           
                        {/* Site Photos */}
                        <div className="mb-8">
                            <h3 className="font-bold mb-4">Site Photos</h3>
                            
                            {photos.length > 0 ? (
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                    {photos.map(photo => (
                                        <div key={photo.id} className="relative group">
                                            <img 
                                                src={photo.url} 
                                                alt={photo.notes || "Site photo"}
                                                className="w-full h-48 object-cover rounded-lg"
                                                onError={(e) => {
                                                    e.target.onerror = null;
                                                    e.target.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23f0f0f0'/%3E%3Ctext x='50' y='50' text-anchor='middle' dy='.3em' fill='%23999'%3EPhoto%3C/text%3E%3C/svg%3E";
                                                }}
                                            />
                                            <button
                                                onClick={() => removePhoto(photo.id)}
                                                className="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"
                                            >
                                                Ã—
                                            </button>
                                            {photo.notes && (
                                                <div className="absolute bottom-0 left-0 right-0 bg-black bg-opacity-70 text-white p-2 text-sm rounded-b-lg">
                                                    {photo.notes}
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="text-center p-8 bg-gray-50 rounded-lg mb-6">
                                    <i className="fas fa-camera text-gray-400 text-3xl mb-3"></i>
                                    <p className="text-gray-600">No photos added yet</p>
                                </div>
                            )}
                            
                            <div className="flex gap-3">
                                <input
                                    type="text"
                                    value={photoNotes}
                                    onChange={(e) => setPhotoNotes(e.target.value)}
                                    placeholder="Photo description"
                                    className="flex-1 form-input"
                                />
                                <input
                                    type="file"
                                    ref={fileInputRef}
                                    onChange={handleFileChange}
                                    accept="image/*"
                                    multiple
                                    className="hidden"
                                />
                                <button
                                    onClick={() => fileInputRef.current.click()}
                                    className="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg"
                                >
                                    <i className="fas fa-upload mr-2"></i>
                                    Upload Photos
                                </button>
                            </div>
                        </div>
                        
                        {/* Zones List */}
                        <div>
                            <h3 className="font-bold mb-4">Saved Zones ({zones.length})</h3>
                            
                            {zones.length === 0 ? (
                                <div className="text-center p-8 bg-gray-50 rounded-lg">
                                    <i className="fas fa-map-marker-alt text-gray-400 text-3xl mb-3"></i>
                                    <p className="text-gray-600">No zones saved yet. Draw on the map and click "Add Zone".</p>
                                </div>
                            ) : (
                                <div className="overflow-x-auto">
                                    <table className="min-w-full divide-y divide-gray-200">
                                        <thead className="bg-gray-50">
                                            <tr>
                                                <th className="px-4 py-3 text-left">Name</th>
                                                <th className="px-4 py-3 text-left">Type</th>
                                                <th className="px-4 py-3 text-left">Notes</th>
                                                <th className="px-4 py-3 text-left">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-200">
                                            {zones.map(zone => (
                                                <tr key={zone.id} className="hover:bg-gray-50">
                                                    <td className="px-4 py-3">{zone.name}</td>
                                                    <td className="px-4 py-3">
                                                        <span className={`px-2 py-1 rounded-full text-xs ${
                                                            zone.type === 'management' ? 'bg-blue-100 text-blue-800' :
                                                            zone.type === 'problem' ? 'bg-red-100 text-red-800' :
                                                            zone.type === 'sensitive' ? 'bg-green-100 text-green-800' :
                                                            'bg-orange-100 text-orange-800'
                                                        }`}>
                                                            {zone.type}
                                                        </span>
                                                    </td>
                                                    <td className="px-4 py-3 text-sm text-gray-600">{zone.notes || '-'}</td>
                                                    <td className="px-4 py-3">
                                                        <button
                                                            onClick={() => {
                                                                setEditingZone(zone.id);
                                                                setZoneName(zone.name);
                                                                setZoneType(zone.type);
                                                                setZoneNotes(zone.notes || '');
                                                            }}
                                                            className="text-blue-600 hover:text-blue-800 mr-3"
                                                        >
                                                            Edit
                                                        </button>
                                                        <button
                                                            onClick={() => {
                                                                if (confirm('Delete this zone?')) {
                                                                    removeZone(zone.id);
                                                                }
                                                            }}
                                                            className="text-red-600 hover:text-red-800"
                                                        >
                                                            Delete
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // Action Plan Component
        function ActionPlan({ recommendations, problems }) {
            const [activeCategory, setActiveCategory] = useState('all');
            
            const categories = [
                { id: 'all', label: 'All Recommendations', count: recommendations.length },
                { id: 'vegetation', label: 'Weed & Vegetation', count: recommendations.filter(r => r.category === 'vegetation').length },
                { id: 'soil', label: 'Soil & Erosion', count: recommendations.filter(r => r.category === 'soil').length },
                { id: 'water', label: 'Water Management', count: recommendations.filter(r => r.category === 'water').length },
                { id: 'biodiversity', label: 'Biodiversity', count: recommendations.filter(r => r.category === 'biodiversity').length },
                { id: 'fire', label: 'Fire Management', count: recommendations.filter(r => r.category === 'fire').length }
            ];
            
            const filteredRecs = activeCategory === 'all' 
                ? recommendations 
                : recommendations.filter(r => r.category === activeCategory);
            
            return (
                <div className="max-w-6xl mx-auto">
                    <div className="flex justify-between items-center mb-8">
                        <div>
                            <h2 className="text-2xl font-bold text-gray-800">Action Plan</h2>
                            <p className="text-gray-600">Customized recommendations based on your property assessment</p>
                        </div>
                        <div className="text-sm text-gray-500">
                            {recommendations.length} recommendations generated
                        </div>
                    </div>
                    
                    {/* Category Filter */}
                    <div className="flex overflow-x-auto mb-8 pb-2">
                        {categories.map(cat => (
                            <button
                                key={cat.id}
                                onClick={() => setActiveCategory(cat.id)}
                                className={`px-4 py-2 rounded-lg mr-2 whitespace-nowrap ${
                                    activeCategory === cat.id
                                        ? 'bg-green-600 text-white'
                                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                }`}
                            >
                                {cat.label} ({cat.count})
                            </button>
                        ))}
                    </div>
                    
                    {recommendations.length === 0 ? (
                        <div className="card text-center p-12">
                            <i className="fas fa-lightbulb text-gray-400 text-5xl mb-4"></i>
                            <h3 className="text-xl font-bold mb-2">No Recommendations Yet</h3>
                            <p className="text-gray-600 mb-6">Complete the property assessment to generate customized recommendations.</p>
                        </div>
                    ) : (
                        <div className="space-y-6">
                            {filteredRecs.map((rec, index) => (
                                <div key={index} className="card">
                                    <div className="flex justify-between items-start mb-4">
                                        <div>
                                            <h3 className="text-xl font-bold">{rec.title}</h3>
                                            <div className="flex items-center mt-1">
                                                <span className={`priority-badge priority-${rec.priority} mr-3`}>
                                                    {rec.priority} priority
                                                </span>
                                                <span className="text-sm text-gray-600">
                                                    <i className="far fa-clock mr-1"></i>
                                                    {rec.timeframe || '12-24 months'}
                                                </span>
                                                <span className="text-sm text-gray-600 ml-3">
                                                    <i className="fas fa-dollar-sign mr-1"></i>
                                                    Estimated: ${rec.estimatedCost?.toLocaleString() || '5,000'}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="mb-6">
                                        <h4 className="font-bold mb-2 text-gray-700">Why this is important:</h4>
                                        <p className="text-gray-700">{rec.whyImportant}</p>
                                    </div>
                                    
                                    <div className="mb-6">
                                        <h4 className="font-bold mb-3 text-gray-700">Recommended Actions:</h4>
                                        <div className="space-y-2">
                                            {rec.actions.map((action, i) => (
                                                <div key={i} className="flex items-start">
                                                    <div className="flex-shrink-0 w-6 h-6 bg-green-100 rounded-full flex items-center justify-center mr-3 mt-0.5">
                                                        <i className="fas fa-check text-green-600 text-xs"></i>
                                                    </div>
                                                    <span>{action}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    {rec.resources && rec.resources.length > 0 && (
                                        <div>
                                            <h4 className="font-bold mb-3 text-gray-700">Available Resources:</h4>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                {rec.resources.map((resource, i) => (
                                                    <div key={i} className="p-3 border rounded-lg hover:bg-gray-50">
                                                        <div className="font-medium">{resource.name}</div>
                                                        <div className="text-sm text-gray-600">{resource.provider}</div>
                                                        <div className="text-sm mt-1">
                                                            <span className="font-medium">Amount:</span> {resource.amount}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        // Implementation Component
        function Implementation({ timeline, budget, recommendations }) {
            const [timeframeFilter, setTimeframeFilter] = useState('all');
            
            const totalCost = budget?.estimatedCost || 0;
            const timelineItems = timeline || [];
            
            const timeGroups = {
                'immediate': timelineItems.filter(t => t.timeframe.includes('1-2') || t.timeframe === 'Immediate'),
                'short-term': timelineItems.filter(t => t.timeframe.includes('3-6')),
                'medium-term': timelineItems.filter(t => t.timeframe.includes('6-12')),
                'long-term': timelineItems.filter(t => t.timeframe.includes('12') || t.timeframe.includes('24'))
            };
            
            const filteredTimeline = timeframeFilter === 'all' 
                ? timelineItems 
                : timeGroups[timeframeFilter] || [];
            
            return (
                <div className="max-w-6xl mx-auto">
                    <div className="flex justify-between items-center mb-8">
                        <div>
                            <h2 className="text-2xl font-bold text-gray-800">Implementation Plan</h2>
                            <p className="text-gray-600">Timeline, budget, and implementation details</p>
                        </div>
                    </div>
                    
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        {/* Left Column - Timeline */}
                        <div className="lg:col-span-2">
                            <div className="card mb-8">
                                <h3 className="text-lg font-bold mb-6">Action Timeline</h3>
                                
                                {/* Timeframe Filter */}
                                <div className="flex mb-6 overflow-x-auto">
                                    <button
                                        onClick={() => setTimeframeFilter('all')}
                                        className={`px-4 py-2 rounded-l-lg ${
                                            timeframeFilter === 'all'
                                                ? 'bg-green-600 text-white'
                                                : 'bg-gray-100 text-gray-700'
                                        }`}
                                    >
                                        All Actions
                                    </button>
                                    <button
                                        onClick={() => setTimeframeFilter('immediate')}
                                        className={`px-4 py-2 ${
                                            timeframeFilter === 'immediate'
                                                ? 'bg-green-600 text-white'
                                                : 'bg-gray-100 text-gray-700'
                                        }`}
                                    >
                                        Immediate (1-2 months)
                                    </button>
                                    <button
                                        onClick={() => setTimeframeFilter('short-term')}
                                        className={`px-4 py-2 ${
                                            timeframeFilter === 'short-term'
                                                ? 'bg-green-600 text-white'
                                                : 'bg-gray-100 text-gray-700'
                                        }`}
                                    >
                                        Short-term (3-6 months)
                                    </button>
                                    <button
                                        onClick={() => setTimeframeFilter('medium-term')}
                                        className={`px-4 py-2 ${
                                            timeframeFilter === 'medium-term'
                                                ? 'bg-green-600 text-white'
                                                : 'bg-gray-100 text-gray-700'
                                        }`}
                                    >
                                        Medium-term (6-12 months)
                                    </button>
                                    <button
                                        onClick={() => setTimeframeFilter('long-term')}
                                        className={`px-4 py-2 rounded-r-lg ${
                                            timeframeFilter === 'long-term'
                                                ? 'bg-green-600 text-white'
                                                : 'bg-gray-100 text-gray-700'
                                        }`}
                                    >
                                        Long-term (12+ months)
                                    </button>
                                </div>
                                
                                {filteredTimeline.length === 0 ? (
                                    <div className="text-center p-8">
                                        <i className="fas fa-calendar-alt text-gray-400 text-4xl mb-3"></i>
                                        <p className="text-gray-600">No timeline items for selected filter.</p>
                                    </div>
                                ) : (
                                    <div className="space-y-4">
                                        {filteredTimeline.map((item, index) => (
                                            <div key={index} className="border-l-4 border-green-500 pl-4 py-3">
                                                <div className="flex justify-between items-start">
                                                    <div>
                                                        <h4 className="font-bold">{item.action}</h4>
                                                        <div className="flex items-center mt-1">
                                                            <span className={`priority-badge priority-${item.priority} mr-3`}>
                                                                {item.priority} priority
                                                            </span>
                                                            <span className="text-sm text-gray-600">
                                                                <i className="far fa-calendar mr-1"></i>
                                                                {item.timeframe}
                                                            </span>
                                                            <span className="text-sm text-gray-600 ml-3">
                                                                <i className="fas fa-sun mr-1"></i>
                                                                Best in {item.season}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                                {item.details && (
                                                    <p className="mt-2 text-gray-700">{item.details}</p>
                                                )}
                                                {item.responsible && (
                                                    <div className="mt-2 text-sm text-gray-600">
                                                        <i className="fas fa-user mr-1"></i>
                                                        Responsible: {item.responsible}
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                        
                        {/* Right Column - Budget & Summary */}
                        <div>
                            <div className="card mb-6">
                                <h3 className="text-lg font-bold mb-4">Budget Summary</h3>
                                
                                <div className="mb-6">
                                    <div className="text-center p-4 bg-green-50 rounded-lg">
                                        <div className="text-3xl font-bold text-green-700">
                                            ${totalCost.toLocaleString()}
                                        </div>
                                        <div className="text-gray-600">Total Estimated Cost</div>
                                    </div>
                                </div>
                                
                                {budget?.items?.length > 0 ? (
                                    <div>
                                        <h4 className="font-medium mb-3">Cost Breakdown</h4>
                                        <div className="space-y-3">
                                            {budget.items.map((item, index) => (
                                                <div key={index} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                                    <div>
                                                        <div className="font-medium">{item.item}</div>
                                                        <div className="text-sm text-gray-600">{item.timeframe}</div>
                                                    </div>
                                                    <div className="font-bold">
                                                        ${item.cost.toLocaleString()}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ) : (
                                    <p className="text-gray-500 text-center p-4">
                                        Complete recommendations to generate budget estimates.
                                    </p>
                                )}
                            </div>
                            
                            <div className="card">
                                <h3 className="text-lg font-bold mb-4">Implementation Checklist</h3>
                                <div className="space-y-3">
                                    <div className="flex items-center">
                                        <input type="checkbox" className="mr-3" />
                                        <span>Property assessment completed</span>
                                    </div>
                                    <div className="flex items-center">
                                        <input type="checkbox" className="mr-3" />
                                        <span>Map zones identified</span>
                                    </div>
                                    <div className="flex items-center">
                                        <input type="checkbox" className="mr-3" />
                                        <span>Recommendations reviewed</span>
                                    </div>
                                    <div className="flex items-center">
                                        <input type="checkbox" className="mr-3" />
                                        <span>Budget prepared</span>
                                    </div>
                                    <div className="flex items-center">
                                        <input type="checkbox" className="mr-3" />
                                        <span>Funding sources identified</span>
                                    </div>
                                    <div className="flex items-center">
                                        <input type="checkbox" className="mr-3" />
                                        <span>Implementation timeline created</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Resources Component
        function Resources({ state, contacts, addContact, fundingPrograms }) {
            const [newContact, setNewContact] = useState({
                name: '',
                organization: '',
                role: '',
                phone: '',
                email: '',
                notes: ''
            });
            
            const localFunding = fundingPrograms[state] || [];
            
            const handleContactSubmit = (e) => {
                e.preventDefault();
                if (newContact.name && newContact.organization) {
                    addContact(newContact);
                    setNewContact({
                        name: '',
                        organization: '',
                        role: '',
                        phone: '',
                        email: '',
                        notes: ''
                    });
                } else {
                    alert('Please fill in at least name and organization');
                }
            };
            
            const resourceCategories = [
                {
                    title: 'Technical Guidance',
                    resources: [
                        { name: 'NRM Technical Manuals', url: 'https://www.nrm.gov.au/resources' },
                        { name: 'Soil Health Guide', url: 'https://www.soilhealth.com' },
                        { name: 'Native Plant Database', url: 'https://www.anbg.gov.au' }
                    ]
                },
                {
                    title: 'Regulatory Information',
                    resources: [
                        { name: 'Environmental Regulations', url: 'https://www.legislation.gov.au' },
                        { name: 'Clearing Permits', url: 'https://www.environment.gov.au' },
                        { name: 'Water Licensing', url: 'https://www.water.gov.au' }
                    ]
                },
                {
                    title: 'Community Support',
                    resources: [
                        { name: 'Landcare Australia', url: 'https://landcareaustralia.org.au' },
                        { name: 'Local Catchment Groups', url: 'https://www.catchmentgroups.org.au' },
                        { name: 'Farmers for Climate Action', url: 'https://farmersforclimateaction.org.au' }
                    ]
                }
            
            ];
            
            return (
                <div className="max-w-6xl mx-auto">
                    <div className="flex justify-between items-center mb-8">
                        <div>
                            <h2 className="text-2xl font-bold text-gray-800">Resources & Contacts</h2>
                            <p className="text-gray-600">Funding opportunities, technical resources, and local contacts</p>
                        </div>
                    </div>
                    
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        {/* Left Column - Funding & Resources */}
                        <div>
                            <div className="card mb-6">
                                <h3 className="text-lg font-bold mb-4">Funding Opportunities ({state})</h3>
                                
                                {localFunding.length === 0 ? (
                                    <p className="text-gray-500 p-4 text-center">
                                        {state ? `No funding programs found for ${state}` : 'Select your state in Property Profile to see funding programs.'}
                                    </p>
                                ) : (
                                    <div className="space-y-4">
                                        {localFunding.map((program, index) => (
                                            <div key={index} className="p-4 border rounded-lg hover:bg-gray-50">
                                                <div className="font-bold mb-1">{program.name}</div>
                                                <div className="text-sm text-gray-600 mb-2">{program.provider}</div>
                                                <div className="flex justify-between text-sm">
                                                    <span>
                                                        <i className="fas fa-dollar-sign mr-1"></i>
                                                        {program.amount}
                                                    </span>
                                                    <span>
                                                        <i className="far fa-clock mr-1"></i>
                                                        Deadline: {program.deadline}
                                                    </span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                            
                            <div className="card">
                                <h3 className="text-lg font-bold mb-4">Online Resources</h3>
                                
                                <div className="space-y-6">
                                    {resourceCategories.map((category, index) => (
                                        <div key={index}>
                                            <h4 className="font-bold mb-3">{category.title}</h4>
                                            <div className="space-y-2">
                                                {category.resources.map((resource, i) => (
                                                    <a
                                                        key={i}
                                                        href={resource.url}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        className="flex items-center p-3 hover:bg-gray-50 rounded-lg"
                                                    >
                                                        <i className="fas fa-external-link-alt text-gray-400 mr-3"></i>
                                                        <span>{resource.name}</span>
                                                    </a>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                        
                        {/* Right Column - Contacts */}
                        <div>
                            <div className="card mb-6">
                                <h3 className="text-lg font-bold mb-4">Key Contacts</h3>
                                
                                <form onSubmit={handleContactSubmit} className="space-y-4 mb-6">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label className="form-label">Name *</label>
                                            <input
                                                type="text"
                                                value={newContact.name}
                                                onChange={(e) => setNewContact({...newContact, name: e.target.value})}
                                                className="form-input"
                                                required
                                            />
                                        </div>
                                        <div>
                                            <label className="form-label">Organization *</label>
                                            <input
                                                type="text"
                                                value={newContact.organization}
                                                onChange={(e) => setNewContact({...newContact, organization: e.target.value})}
                                                className="form-input"
                                                required
                                            />
                                        </div>
                                    </div>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label className="form-label">Role</label>
                                            <input
                                                type="text"
                                                value={newContact.role}
                                                onChange={(e) => setNewContact({...newContact, role: e.target.value})}
                                                className="form-input"
                                            />
                                        </div>
                                        <div>
                                            <label className="form-label">Phone</label>
                                            <input
                                                type="tel"
                                                value={newContact.phone}
                                                onChange={(e) => setNewContact({...newContact, phone: e.target.value})}
                                                className="form-input"
                                            />
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label className="form-label">Email</label>
                                        <input
                                            type="email"
                                            value={newContact.email}
                                            onChange={(e) => setNewContact({...newContact, email: e.target.value})}
                                            className="form-input"
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="form-label">Notes</label>
                                        <textarea
                                            value={newContact.notes}
                                            onChange={(e) => setNewContact({...newContact, notes: e.target.value})}
                                            className="form-input"
                                            rows="2"
                                        />
                                    </div>
                                    
                                    <button type="submit" className="btn-primary">
                                        <i className="fas fa-plus mr-2"></i>
                                        Add Contact
                                    </button>
                                </form>
                                
                                {contacts.length === 0 ? (
                                    <p className="text-gray-500 p-4 text-center">
                                        No contacts added yet.
                                    </p>
                                ) : (
                                    <div className="space-y-3">
                                        {contacts.map(contact => (
                                            <div key={contact.id} className="p-4 border rounded-lg">
                                                <div className="font-bold">{contact.name}</div>
                                                <div className="text-sm text-gray-600">{contact.organization}</div>
                                                {contact.role && <div className="text-sm">{contact.role}</div>}
                                                <div className="mt-2 text-sm">
                                                    {contact.phone && (
                                                        <div><i className="fas fa-phone mr-2"></i>{contact.phone}</div>
                                                    )}
                                                    {contact.email && (
                                                        <div><i className="fas fa-envelope mr-2"></i>{contact.email}</div>
                                                    )}
                                                </div>
                                                {contact.notes && (
                                                    <div className="mt-2 text-sm text-gray-600">{contact.notes}</div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                            
                            <div className="card">
                                <h3 className="text-lg font-bold mb-4">Next Steps</h3>
                                <div className="space-y-3">
                                    <div className="flex items-center p-3 bg-blue-50 rounded-lg">
                                        <i className="fas fa-file-contract text-blue-500 mr-3"></i>
                                        <div>
                                            <div className="font-medium">Review your action plan</div>
                                            <div className="text-sm text-gray-600">Make any final adjustments</div>
                                        </div>
                                    </div>
                                    <div className="flex items-center p-3 bg-green-50 rounded-lg">
                                        <i className="fas fa-download text-green-500 mr-3"></i>
                                        <div>
                                            <div className="font-medium">Export your plan</div>
                                            <div className="text-sm text-gray-600">Download PDF and share with stakeholders</div>
                                        </div>
                                    </div>
                                    <div className="flex items-center p-3 bg-purple-50 rounded-lg">
                                        <i className="fas fa-calendar-check text-purple-500 mr-3"></i>
                                        <div>
                                            <div className="font-medium">Schedule implementation</div>
                                            <div className="text-sm text-gray-600">Start with high-priority actions</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Export Panel Component
        function ExportPanel({ formData, clearLocalStorage }) {
            const [exportOptions, setExportOptions] = useState({
                includeMap: true,
                includePhotos: true,
                includeBudget: true,
                includeContacts: true,
                highQuality: false
            });
            
            const [isGenerating, setIsGenerating] = useState(false);
            
            // Generate CSV Export
            const generateCSV = () => {
                try {
                    // Create CSV content
                    let csvContent = "LEAP Pro Export," + new Date().toLocaleDateString() + "\n\n";
                    
                    // Property Information
                    csvContent += "PROPERTY INFORMATION\n";
                    csvContent += "Property Name," + (formData.property.name || "") + "\n";
                    csvContent += "Location," + (formData.property.location || "") + "\n";
                    csvContent += "Size (ha)," + (formData.property.size || "") + "\n";
                    csvContent += "State," + (formData.property.state || "") + "\n\n";
                    
                    // Issues
                    csvContent += "ENVIRONMENTAL ISSUES\n";
                    const issues = [];
                    if (formData.problems.erosion.present) issues.push("Erosion");
                    if (formData.problems.weeds.length > 0) issues.push("Weeds: " + formData.problems.weeds.join(", "));
                    if (formData.problems.habitatLoss.present) issues.push("Habitat Loss");
                    if (formData.problems.waterQuality.present) issues.push("Water Quality");
                    csvContent += "Issues Identified," + issues.join("; ") + "\n\n";
                    
                    // Recommendations
                    csvContent += "RECOMMENDATIONS\n";
                    csvContent += "Title,Priority,Timeframe,Estimated Cost\n";
                    formData.recommendations.forEach(rec => {
                        csvContent += `"${rec.title}",${rec.priority},${rec.timeframe},$${rec.estimatedCost || 0}\n`;
                    });
                    
                    // Budget Summary
                    csvContent += "\nBUDGET SUMMARY\n";
                    csvContent += "Total Estimated Cost,$" + (formData.budget?.estimatedCost || 0) + "\n";
                    
                    // Create and download CSV file
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", `LEAP_${formData.property.name?.replace(/[^a-z0-9]/gi, '_') || 'Property'}_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    alert("CSV file downloaded successfully!");
                } catch (error) {
                    console.error('Error generating CSV:', error);
                    alert('Error generating CSV. Please try again.');
                }
            };
            
            // Generate JSON Export
            const generateJSON = () => {
                try {
                    // Create a clean export object
                    const exportData = {
                        metadata: {
                            exportDate: new Date().toISOString(),
                            tool: "LEAP Pro",
                            version: "1.0"
                        },
                        property: formData.property,
                        assessment: formData.problems,
                        recommendations: formData.recommendations,
                        timeline: formData.timeline,
                        budget: formData.budget,
                        zones: formData.mapZones,
                        contacts: formData.contacts
                    };
                    
                    // Convert to JSON string with pretty formatting
                    const jsonString = JSON.stringify(exportData, null, 2);
                    
                    // Create and download JSON file
                    const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8;' });
                    const link = document.createElement("a");
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", `LEAP_${formData.property.name?.replace(/[^a-z0-9]/gi, '_') || 'Property'}_${new Date().toISOString().split('T')[0]}.json`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    alert("JSON file downloaded successfully!");
                } catch (error) {
                    console.error('Error generating JSON:', error);
                    alert('Error generating JSON. Please try again.');
                }
            };
            
            // Print Summary
            const printSummary = () => {
                try {
                    // Create a printable HTML content
                    const printContent = `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>LEAP Pro Summary - ${formData.property.name || 'Property'}</title>
                            <style>
                                body { font-family: Arial, sans-serif; margin: 20px; }
                                h1 { color: #1a5d1a; }
                                h2 { color: #2d936c; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
                                .section { margin-bottom: 30px; }
                                .property-info { background: #f5f5f5; padding: 15px; border-radius: 5px; }
                                .recommendation { margin-bottom: 15px; padding: 10px; border-left: 3px solid #1a5d1a; }
                                .budget { font-weight: bold; font-size: 1.2em; }
                                @media print {
                                    body { margin: 0; }
                                    .no-print { display: none; }
                                }
                            </style>
                        </head>
                        <body>
                            <div class="no-print" style="text-align: center; margin-bottom: 20px;">
                                <button onclick="window.print()" style="padding: 10px 20px; background: #1a5d1a; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                    Print This Page
                                </button>
                                <button onclick="window.close()" style="padding: 10px 20px; margin-left: 10px; background: #666; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                    Close
                                </button>
                            </div>
                            
                            <h1>LEAP Pro - Environmental Action Plan Summary</h1>
                            <p><strong>Generated:</strong> ${new Date().toLocaleDateString('en-AU', { 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric' 
                            })}</p>
                            
                            <div class="section">
                                <h2>Property Information</h2>
                                <div class="property-info">
                                    <p><strong>Property Name:</strong> ${formData.property.name || 'Not specified'}</p>
                                    <p><strong>Location:</strong> ${formData.property.location || 'Not specified'}</p>
                                    <p><strong>Size:</strong> ${formData.property.size || 'Not specified'} hectares</p>
                                    <p><strong>State:</strong> ${formData.property.state || 'Not specified'}</p>
                                </div>
                            </div>
                            
                            <div class="section">
                                <h2>Environmental Assessment Summary</h2>
                                <p><strong>Issues Identified:</strong> ${[
                                    formData.problems.erosion.present ? 'Erosion' : null,
                                    formData.problems.weeds.length > 0 ? 'Weed Problems' : null,
                                    formData.problems.habitatLoss.present ? 'Habitat Loss' : null,
                                    formData.problems.waterQuality.present ? 'Water Quality' : null
                                ].filter(Boolean).join(', ') || 'None'}</p>
                            </div>
                            
                            <div class="section">
                                <h2>Key Recommendations</h2>
                                ${formData.recommendations.length > 0 ? 
                                    formData.recommendations.map(rec => `
                                        <div class="recommendation">
                                            <h3>${rec.title}</h3>
                                            <p><strong>Priority:</strong> ${rec.priority} | <strong>Timeframe:</strong> ${rec.timeframe}</p>
                                            <p><strong>Estimated Cost:</strong> $${rec.estimatedCost || 0}</p>
                                        </div>
                                    `).join('') :
                                    '<p>No recommendations generated yet.</p>'
                                }
                            </div>
                            
                            <div class="section">
                                <h2>Budget Summary</h2>
                                <p class="budget">Total Estimated Cost: $${(formData.budget?.estimatedCost || 0).toLocaleString()}</p>
                            </div>
                            
                            <div class="section">
                                <p><em>This is a summary report. For complete details, refer to the full PDF report.</em></p>
                                <p><strong>Disclaimer:</strong> This plan is for guidance purposes only. Consult with qualified professionals before undertaking any works.</p>
                            </div>
                        </body>
                        </html>
                    `;
                    
                    // Open print window
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(printContent);
                    printWindow.document.close();
                    
                    // Auto-print after content loads
                    printWindow.onload = function() {
                        setTimeout(() => {
                            printWindow.print();
                        }, 500);
                    };
                    
                } catch (error) {
                    console.error('Error generating print summary:', error);
                    alert('Error generating print summary. Please try again.');
                }
            };
            
            // Email Report
            const emailReport = () => {
                try {
                    const subject = encodeURIComponent(`LEAP Pro Report - ${formData.property.name || 'Property'}`);
                    const body = encodeURIComponent(
                        `Please find attached the LEAP Pro environmental action plan for ${formData.property.name || 'the property'}.\n\n` +
                        `Summary:\n` +
                        `- Property: ${formData.property.name || 'Not specified'}\n` +
                        `- Location: ${formData.property.location || 'Not specified'}\n` +
                        `- Issues Identified: ${formData.recommendations.length}\n` +
                        `- Total Estimated Cost: $${(formData.budget?.estimatedCost || 0).toLocaleString()}\n\n` +
                        `This report was generated on ${new Date().toLocaleDateString()}.\n\n` +
                        `Note: The full report should be downloaded from the LEAP Pro application.\n` +
                        `Generated by LEAP Pro - Landholder Environmental Action Planner`
                    );
                    
                    window.location.href = `mailto:?subject=${subject}&body=${body}`;
                    
                } catch (error) {
                    console.error('Error preparing email:', error);
                    alert('Error preparing email. Please try again or use the manual export.');
                }
            };
            
            // Create Backup
            const createBackup = () => {
                try {
                    const backupData = {
                        timestamp: new Date().toISOString(),
                        data: formData
                    };
                    
                    const jsonString = JSON.stringify(backupData, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8;' });
                    const link = document.createElement("a");
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", `LEAP_Backup_${new Date().toISOString().split('T')[0]}.json`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    alert("Backup created successfully!");
                } catch (error) {
                    console.error('Error creating backup:', error);
                    alert('Error creating backup. Please try again.');
                }
            };
            
            // Generate PDF function
            const generatePDF = async () => {
                setIsGenerating(true);
                
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4',
                        compress: true
                    });
                    
                    let yPosition = 20;
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const margin = 20;
                    const contentWidth = pageWidth - (2 * margin);
                    
                    // Helper function to add new page
                    const addNewPageIfNeeded = (spaceNeeded = 10) => {
                        if (yPosition + spaceNeeded > doc.internal.pageSize.getHeight() - 20) {
                            doc.addPage();
                            yPosition = 20;
                            return true;
                        }
                        return false;
                    };
                    
                    // Helper to add section title
                    const addSectionTitle = (title) => {
                        addNewPageIfNeeded(15);
                        doc.setFillColor(26, 93, 26);
                        doc.rect(margin, yPosition - 5, contentWidth, 8, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.text(title, margin + 5, yPosition);
                        yPosition += 12;
                        doc.setTextColor(0, 0, 0);
                    };
                    
                    // Helper to add text with word wrap
                    const addWrappedText = (text, options = {}) => {
                        const { fontSize = 11, font = 'normal', indent = 0 } = options;
                        doc.setFontSize(fontSize);
                        doc.setFont('helvetica', font);
                        
                        const lines = doc.splitTextToSize(text, contentWidth - indent);
                        
                        lines.forEach(line => {
                            addNewPageIfNeeded(7);
                            doc.text(line, margin + indent, yPosition);
                            yPosition += 7;
                        });
                        
                        yPosition += 3;
                    };
                    
                    // Helper to add bullet points
                    const addBulletList = (items, options = {}) => {
                        const { indent = 5, fontSize = 10 } = options;
                        doc.setFontSize(fontSize);
                        
                        items.forEach(item => {
                            addNewPageIfNeeded(6);
                            doc.text('â€¢', margin + indent, yPosition);
                            const lines = doc.splitTextToSize(item, contentWidth - indent - 10);
                            
                            lines.forEach((line, index) => {
                                if (index > 0) addNewPageIfNeeded(6);
                                doc.text(line, margin + indent + 5, yPosition);
                                yPosition += 6;
                            });
                        });
                        
                        yPosition += 3;
                    };
                    
                    // ========== COVER PAGE ==========
                    // Green header
                    doc.setFillColor(26, 93, 26);
                    doc.rect(0, 0, pageWidth, 60, 'F');
                    
                    // Title
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(28);
                    doc.setFont('helvetica', 'bold');
                    doc.text('LEAP Pro Report', pageWidth / 2, 35, { align: 'center' });
                    
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Landholder Environmental Action Planner', pageWidth / 2, 45, { align: 'center' });
                    
                    // Property name box
                    yPosition = 80;
                    doc.setFillColor(240, 240, 240);
                    doc.rect(margin, yPosition, contentWidth, 30, 'F');
                    
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(18);
                    doc.setFont('helvetica', 'bold');
                    doc.text(formData.property.name || 'Unnamed Property', pageWidth / 2, yPosition + 15, { align: 'center' });
                    
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'normal');
                    doc.text(formData.property.location || 'Location not specified', pageWidth / 2, yPosition + 25, { align: 'center' });
                    
                    // Report details
                    yPosition = 130;
                    doc.setFontSize(10);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Report generated: ${new Date().toLocaleDateString('en-AU', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    })}`, margin, yPosition);
                    
                    doc.text(`Property size: ${formData.property.size || 'Not specified'} hectares`, margin, yPosition + 5);
                    doc.text(`State: ${formData.property.state || 'Not specified'}`, margin, yPosition + 10);
                    
                    // QR Code for digital copy (optional)
                    yPosition = 180;
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(9);
                    doc.text('Scan to view digital version:', pageWidth / 2, yPosition, { align: 'center' });
                    doc.setTextColor(26, 93, 26);
                    doc.text('https://leappro.plan', pageWidth / 2, yPosition + 5, { align: 'center' });
                    
                    doc.addPage();
                    yPosition = 20;
                    
                    // ========== TABLE OF CONTENTS ==========
                    addSectionTitle('Table of Contents');
                    
                    const tocItems = [
                        '1. Executive Summary',
                        '2. Property Information',
                        '3. Environmental Assessment',
                        '4. Action Plan Recommendations',
                        '5. Implementation Timeline',
                        '6. Budget Summary',
                        '7. Mapped Zones',
                        '8. Supporting Information'
                    ];
                    
                    tocItems.forEach(item => {
                        addNewPageIfNeeded(8);
                        doc.text(item, margin, yPosition);
                        
                        // Dotted line
                        const textWidth = doc.getTextWidth(item);
                        const dotStart = margin + textWidth + 5;
                        const dotEnd = pageWidth - margin - 20;
                        const dotCount = Math.floor((dotEnd - dotStart) / 2);
                        
                        let dots = '';
                        for (let i = 0; i < dotCount; i++) {
                            dots += '.';
                        }
                        
                        doc.text(dots, dotStart, yPosition);
                        doc.text(`${Math.floor(yPosition)}`, pageWidth - margin, yPosition, { align: 'right' });
                        yPosition += 8;
                    });
                    
                    doc.addPage();
                    yPosition = 20;
                    
                    // ========== EXECUTIVE SUMMARY ==========
                    addSectionTitle('1. Executive Summary');
                    
                    const issueCount = [
                        formData.problems.erosion.present,
                        formData.problems.weeds.length > 0,
                        formData.problems.habitatLoss.present,
                        formData.problems.waterQuality.present,
                        formData.problems.fireRisk.present
                    ].filter(Boolean).length;
                    
                    const summaryText = `
            This environmental action plan has been prepared for ${formData.property.name || 'your property'}. 
            The assessment identified ${issueCount} key environmental issues and developed ${formData.recommendations.length} 
            recommended actions. The total estimated implementation cost is $${(formData.budget?.estimatedCost || 0).toLocaleString()}.
                    `.trim();
                    
                    addWrappedText(summaryText);
                    
                    // Key stats box
                    addNewPageIfNeeded(40);
                    doc.setFillColor(245, 245, 245);
                    doc.rect(margin, yPosition, contentWidth, 35, 'F');
                    doc.setDrawColor(200, 200, 200);
                    doc.rect(margin, yPosition, contentWidth, 35);
                    
                    const stats = [
                        { label: 'Issues Identified', value: issueCount },
                        { label: 'Recommendations', value: formData.recommendations.length },
                        { label: 'Mapped Zones', value: formData.mapZones.length },
                        { label: 'Total Budget', value: `$${(formData.budget?.estimatedCost || 0).toLocaleString()}` }
                    ];
                    
                    const statWidth = contentWidth / 4;
                    stats.forEach((stat, index) => {
                        const x = margin + (index * statWidth);
                        doc.setTextColor(26, 93, 26);
                        doc.setFontSize(16);
                        doc.setFont('helvetica', 'bold');
                        doc.text(stat.value.toString(), x + (statWidth / 2), yPosition + 15, { align: 'center' });
                        
                        doc.setTextColor(100, 100, 100);
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'normal');
                        doc.text(stat.label, x + (statWidth / 2), yPosition + 25, { align: 'center' });
                    });
                    
                    yPosition += 45;
                    
                    // ========== PROPERTY INFORMATION ==========
                    addSectionTitle('2. Property Information');
                    
                    const propertyDetails = [
                        `Property Name: ${formData.property.name || 'Not specified'}`,
                        `Location: ${formData.property.location || 'Not specified'}`,
                        `Size: ${formData.property.size || 'Not specified'} hectares`,
                        `State: ${formData.property.state || 'Not specified'}`,
                        `Rainfall: ${formData.property.rainfall || 'Not specified'}`,
                        `Soil Type: ${formData.property.soilType || 'Not specified'}`,
                        `Elevation: ${formData.property.elevation || 'Not specified'}`
                    ];
                    
                    addBulletList(propertyDetails);
                    
                    // Property Features
                    if (formData.property.features?.length > 0) {
                        addNewPageIfNeeded(10);
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Property Features:', margin, yPosition);
                        yPosition += 7;
                        
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'normal');
                        const featuresText = formData.property.features.join(', ');
                        const featureLines = doc.splitTextToSize(featuresText, contentWidth);
                        
                        featureLines.forEach(line => {
                            addNewPageIfNeeded(6);
                            doc.text(line, margin + 5, yPosition);
                            yPosition += 6;
                        });
                        
                        yPosition += 3;
                    }
                    
                    // ========== ENVIRONMENTAL ASSESSMENT ==========
                    addSectionTitle('3. Environmental Assessment');
                    
                    const issues = [];
                    if (formData.problems.erosion.present) {
                        issues.push(`Soil Erosion (${formData.problems.erosion.severity} severity) - ${formData.problems.erosion.notes || 'No additional notes'}`);
                    }
                    if (formData.problems.weeds.length > 0) {
                        issues.push(`Weed Problems: ${formData.problems.weeds.join(', ')}`);
                    }
                    if (formData.problems.habitatLoss.present) {
                        issues.push(`Habitat Loss (${formData.problems.habitatLoss.severity} severity)`);
                    }
                    if (formData.problems.waterQuality.present) {
                        issues.push(`Water Quality Issues (${formData.problems.waterQuality.severity} severity)`);
                    }
                    if (formData.problems.fireRisk.present) {
                        issues.push(`Fire Risk (${formData.problems.fireRisk.severity} severity)`);
                    }
                    if (formData.problems.salinity.present) {
                        issues.push(`Salinity (${formData.problems.salinity.severity} severity)`);
                    }
                    if (formData.problems.feralAnimals.present && formData.problems.feralAnimals.species.length > 0) {
                        issues.push(`Feral Animals: ${formData.problems.feralAnimals.species.join(', ')}`);
                    }
                    
                    if (issues.length === 0) {
                        issues.push('No significant environmental issues identified during assessment.');
                    }
                    
                    addBulletList(issues);
                    
                    // ========== ACTION PLAN ==========
                    addSectionTitle('4. Action Plan Recommendations');
                    
                    if (formData.recommendations.length === 0) {
                        addWrappedText('No recommendations generated. Complete the property assessment to generate action items.');
                    } else {
                        formData.recommendations.forEach((rec, index) => {
                            addNewPageIfNeeded(20);
                            
                            // Recommendation header
                            doc.setFillColor(240, 240, 240);
                            doc.rect(margin, yPosition - 5, contentWidth, 10, 'F');
                            
                            doc.setTextColor(0, 0, 0);
                            doc.setFontSize(12);
                            doc.setFont('helvetica', 'bold');
                            doc.text(`${index + 1}. ${rec.title}`, margin + 2, yPosition);
                            yPosition += 7;
                            
                            // Priority and cost
                            doc.setFontSize(10);
                            doc.setTextColor(100, 100, 100);
                            const details = `Priority: ${rec.priority.toUpperCase()} | Timeframe: ${rec.timeframe} | Est. Cost: $${rec.estimatedCost?.toLocaleString() || '5,000'}`;
                            doc.text(details, margin + 2, yPosition);
                            yPosition += 10;
                            
                            // Why important
                            doc.setTextColor(0, 0, 0);
                            doc.setFont('helvetica', 'bold');
                            doc.text('Why this is important:', margin, yPosition);
                            yPosition += 6;
                            
                            doc.setFont('helvetica', 'normal');
                            addWrappedText(rec.whyImportant, { fontSize: 10 });
                            
                            // Actions
                            doc.setFont('helvetica', 'bold');
                            addNewPageIfNeeded(10);
                            doc.text('Recommended Actions:', margin, yPosition);
                            yPosition += 6;
                            
                            addBulletList(rec.actions, { fontSize: 10 });
                            
                            yPosition += 5;
                        });
                    }
                    
                    // ========== TIMELINE ==========
                    if (formData.timeline.length > 0) {
                        addSectionTitle('5. Implementation Timeline');
                        
                        formData.timeline.forEach((item, index) => {
                            addNewPageIfNeeded(15);
                            
                            // Timeline item
                            doc.setFillColor(250, 250, 250);
                            doc.rect(margin, yPosition - 3, contentWidth, 12, 'F');
                            doc.setDrawColor(220, 220, 220);
                            doc.rect(margin, yPosition - 3, contentWidth, 12);
                            
                            doc.setTextColor(0, 0, 0);
                            doc.setFontSize(11);
                            doc.setFont('helvetica', 'bold');
                            doc.text(`${index + 1}. ${item.action}`, margin + 5, yPosition + 3);
                            yPosition += 8;
                            
                            // Details
                            doc.setFontSize(9);
                            doc.setFont('helvetica', 'normal');
                            doc.setTextColor(100, 100, 100);
                            const details = `Timeframe: ${item.timeframe} | Priority: ${item.priority} | Best Season: ${item.season}`;
                            doc.text(details, margin + 5, yPosition + 3);
                            
                            if (item.details) {
                                yPosition += 6;
                                doc.setFontSize(9);
                                const detailLines = doc.splitTextToSize(item.details, contentWidth - 10);
                                detailLines.forEach(line => {
                                    addNewPageIfNeeded(6);
                                    doc.text(line, margin + 10, yPosition + 3);
                                    yPosition += 6;
                                });
                            }
                            
                            yPosition += 8;
                        });
                    }
                    
                    // ========== BUDGET ==========
                    addSectionTitle('6. Budget Summary');
                    
                    addNewPageIfNeeded(15);
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(26, 93, 26);
                    doc.text(`Total Estimated Cost: $${(formData.budget?.estimatedCost || 0).toLocaleString()}`, 
                            pageWidth / 2, yPosition, { align: 'center' });
                    yPosition += 10;
                    
                    if (formData.budget?.items?.length > 0) {
                        // Create a simple table
                        const tableTop = yPosition + 5;
                        const col1Width = contentWidth * 0.6;
                        const col2Width = contentWidth * 0.4;
                        
                        // Table header
                        doc.setFillColor(240, 240, 240);
                        doc.rect(margin, tableTop, col1Width, 8, 'F');
                        doc.rect(margin + col1Width, tableTop, col2Width, 8, 'F');
                        
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Item', margin + 5, tableTop + 5);
                        doc.text('Cost', margin + col1Width + 5, tableTop + 5);
                        
                        let currentY = tableTop + 8;
                        
                        formData.budget.items.forEach((item, index) => {
                            addNewPageIfNeeded(12);
                            
                            // Alternate row colors
                            if (index % 2 === 0) {
                                doc.setFillColor(250, 250, 250);
                                doc.rect(margin, currentY, contentWidth, 10, 'F');
                            }
                            
                            doc.setDrawColor(220, 220, 220);
                            doc.rect(margin, currentY, contentWidth, 10);
                            
                            doc.setTextColor(0, 0, 0);
                            doc.setFontSize(9);
                            doc.setFont('helvetica', 'normal');
                            
                            // Item name (with word wrap)
                            const itemLines = doc.splitTextToSize(item.item, col1Width - 10);
                            itemLines.forEach((line, lineIndex) => {
                                doc.text(line, margin + 5, currentY + 5 + (lineIndex * 4));
                            });
                            
                            // Cost
                            doc.setFont('helvetica', 'bold');
                            doc.text(`$${item.cost.toLocaleString()}`, margin + col1Width + 5, currentY + 5);
                            
                            currentY += Math.max(10, (itemLines.length * 4) + 2);
                            yPosition = currentY;
                        });
                        
                        yPosition += 10;
                    }
                    
                    // ========== MAPPED ZONES ==========
                    if (formData.mapZones.length > 0) {
                        addSectionTitle('7. Mapped Zones');
                        
                        formData.mapZones.forEach((zone, index) => {
                            addNewPageIfNeeded(15);
                            
                            doc.setFontSize(11);
                            doc.setFont('helvetica', 'bold');
                            doc.text(`${index + 1}. ${zone.name}`, margin, yPosition);
                            yPosition += 6;
                            
                            doc.setFontSize(10);
                            doc.setFont('helvetica', 'normal');
                            doc.text(`Type: ${zone.type.charAt(0).toUpperCase() + zone.type.slice(1)}`, margin, yPosition);
                            yPosition += 5;
                            
                            if (zone.notes) {
                                const noteLines = doc.splitTextToSize(`Notes: ${zone.notes}`, contentWidth);
                                noteLines.forEach(line => {
                                    addNewPageIfNeeded(6);
                                    doc.text(line, margin, yPosition);
                                    yPosition += 5;
                                });
                            }
                            
                            yPosition += 5;
                        });
                    }
                    
                    // ========== SUPPORTING INFORMATION ==========
                    addSectionTitle('8. Supporting Information');
                    
                    // Photos count
                    if (formData.photos.length > 0) {
                        addNewPageIfNeeded();
                        doc.setFontSize(11);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Site Documentation:', margin, yPosition);
                        yPosition += 6;
                        
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`${formData.photos.length} photos taken during site assessment`, margin, yPosition);
                        yPosition += 8;
                    }
                    
                    // Contacts
                    if (formData.contacts.length > 0) {
                        addNewPageIfNeeded();
                        doc.setFontSize(11);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Key Contacts:', margin, yPosition);
                        yPosition += 6;
                        
                        formData.contacts.slice(0, 3).forEach(contact => {
                            addNewPageIfNeeded(15);
                            doc.setFontSize(10);
                            doc.setFont('helvetica', 'normal');
                            
                            doc.text(contact.name, margin, yPosition);
                            yPosition += 4;
                            
                            doc.text(contact.organization, margin, yPosition);
                            yPosition += 4;
                            
                            if (contact.role) {
                                doc.text(contact.role, margin, yPosition);
                                yPosition += 4;
                            }
                            
                            if (contact.phone) {
                                doc.text(`Phone: ${contact.phone}`, margin, yPosition);
                                yPosition += 4;
                            }
                            
                            yPosition += 5;
                        });
                    }
                    
                    // ========== FINAL PAGE - DISCLAIMER ==========
                    doc.addPage();
                    yPosition = 20;
                    
                    addSectionTitle('Disclaimer & Notes');
                    
                    const disclaimer = `
            This environmental action plan has been generated using the LEAP Pro tool. It is intended as a planning guide only and should not be considered professional advice.

            Important Considerations:
            â€¢ Consult with qualified professionals before undertaking any works
            â€¢ Check local council and state regulations
            â€¢ Obtain necessary permits and approvals
            â€¢ Consider seasonal and weather conditions
            â€¢ Review costs with local contractors
            â€¢ Adapt recommendations to your specific circumstances

            This plan should be reviewed and updated annually or as conditions change.

            For further assistance, contact your local NRM officer or Landcare group.
                    `.trim();
                    
                    addWrappedText(disclaimer, { fontSize: 10 });
                    
                    // Footer on all pages
                    const totalPages = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= totalPages; i++) {
                        doc.setPage(i);
                        
                        // Page number
                        doc.setFontSize(8);
                        doc.setTextColor(100, 100, 100);
                        doc.text(`Page ${i} of ${totalPages}`, pageWidth - margin, doc.internal.pageSize.getHeight() - 10, { align: 'right' });
                        
                        // Confidential stamp on first page
                        if (i === 1) {
                            doc.setFontSize(10);
                            doc.setTextColor(26, 93, 26);
                            doc.text('CONFIDENTIAL - PROPERTY MANAGEMENT PLAN', pageWidth / 2, doc.internal.pageSize.getHeight() - 10, { align: 'center' });
                        }
                        
                        // LEAP Pro footer
                        doc.setFontSize(7);
                        doc.setTextColor(150, 150, 150);
                        doc.text('Generated by LEAP Pro - Landholder Environmental Action Planner', margin, doc.internal.pageSize.getHeight() - 10);
                    }
                    
                    // Save the PDF
                    const fileName = `LEAP_${formData.property.name?.replace(/[^a-z0-9]/gi, '_') || 'Property'}_${new Date().toISOString().split('T')[0]}.pdf`;
                    doc.save(fileName);
                    
                    setIsGenerating(false);
                    
                    // Optional: Show success message
                    alert(`PDF generated successfully: ${fileName}`);
                    
                } catch (error) {
                    console.error('Error generating PDF:', error);
                    alert('Error generating PDF. Please try again or use CSV export.');
                    setIsGenerating(false);
                }
            };
            
            return (
                <div className="max-w-4xl mx-auto">
                    <div className="flex justify-between items-center mb-8">
                        <div>
                            <h2 className="text-2xl font-bold text-gray-800">Export & Share</h2>
                            <p className="text-gray-600">Generate reports and share your environmental action plan</p>
                        </div>
                    </div>
                    
                    <div className="card mb-6">
                        <h3 className="text-lg font-bold mb-6">Export Options</h3>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            {/* PDF Export */}
                            <div className="space-y-4">
                                <div className="flex items-center">
                                    <div className="bg-red-100 p-3 rounded-lg mr-4">
                                        <i className="fas fa-file-pdf text-red-600 text-2xl"></i>
                                    </div>
                                    <div>
                                        <h4 className="font-bold">PDF Report</h4>
                                        <p className="text-sm text-gray-600">Comprehensive report with all details</p>
                                    </div>
                                </div>
                                
                                <div className="space-y-3">
                                    <label className="flex items-center">
                                        <input 
                                            type="checkbox" 
                                            checked={exportOptions.includeMap}
                                            onChange={(e) => setExportOptions({...exportOptions, includeMap: e.target.checked})}
                                            className="mr-2" 
                                        />
                                        Include map zones
                                    </label>
                                    <label className="flex items-center">
                                        <input 
                                            type="checkbox" 
                                            checked={exportOptions.includePhotos}
                                            onChange={(e) => setExportOptions({...exportOptions, includePhotos: e.target.checked})}
                                            className="mr-2" 
                                        />
                                        Include photos
                                    </label>
                                    <label className="flex items-center">
                                        <input 
                                            type="checkbox" 
                                            checked={exportOptions.includeBudget}
                                            onChange={(e) => setExportOptions({...exportOptions, includeBudget: e.target.checked})}
                                            className="mr-2" 
                                        />
                                        Include budget details
                                    </label>
                                    <label className="flex items-center">
                                        <input 
                                            type="checkbox" 
                                            checked={exportOptions.includeContacts}
                                            onChange={(e) => setExportOptions({...exportOptions, includeContacts: e.target.checked})}
                                            className="mr-2" 
                                        />
                                        Include contact information
                                    </label>
                                    <label className="flex items-center">
                                        <input 
                                            type="checkbox" 
                                            checked={exportOptions.highQuality}
                                            onChange={(e) => setExportOptions({...exportOptions, highQuality: e.target.checked})}
                                            className="mr-2" 
                                        />
                                        High quality (larger file)
                                    </label>
                                </div>
                                
                                <button 
                                    onClick={generatePDF}
                                    disabled={isGenerating}
                                    className="w-full btn-primary"
                                >
                                    {isGenerating ? (
                                        <>
                                            <i className="fas fa-spinner fa-spin mr-2"></i>
                                            Generating PDF...
                                        </>
                                    ) : (
                                        <>
                                            <i className="fas fa-download mr-2"></i>
                                            Download PDF Report
                                        </>
                                    )}
                                </button>
                            </div>
                            
                            {/* Data Export */}
                            <div className="space-y-4">
                                <div className="flex items-center">
                                    <div className="bg-green-100 p-3 rounded-lg mr-4">
                                        <i className="fas fa-file-csv text-green-600 text-2xl"></i>
                                    </div>
                                    <div>
                                        <h4 className="font-bold">Data Export</h4>
                                        <p className="text-sm text-gray-600">Export data for use in other applications</p>
                                    </div>
                                </div>
                                
                                <div className="space-y-3">
                                    <button 
                                        onClick={generateCSV}
                                        className="w-full text-left p-3 border rounded-lg hover:bg-gray-50 cursor-pointer"
                                    >
                                        <div className="font-medium">CSV Data Export</div>
                                        <div className="text-sm text-gray-600">Spreadsheet-friendly format</div>
                                    </button>
                                    
                                    <button 
                                        onClick={generateJSON}
                                        className="w-full text-left p-3 border rounded-lg hover:bg-gray-50 cursor-pointer"
                                    >
                                        <div className="font-medium">JSON Data Export</div>
                                        <div className="text-sm text-gray-600">For developers and APIs</div>
                                    </button>
                                    
                                    <button 
                                        onClick={printSummary}
                                        className="w-full text-left p-3 border rounded-lg hover:bg-gray-50 cursor-pointer"
                                    >
                                        <div className="font-medium">Print Summary</div>
                                        <div className="text-sm text-gray-600">Printer-friendly version</div>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div className="card">
                        <h3 className="text-lg font-bold mb-4">Sharing Options</h3>
                        
                        <div className="space-y-4">
                            <div className="p-4 bg-blue-50 rounded-lg">
                                <h4 className="font-bold mb-2">Share with Stakeholders</h4>
                                <p className="text-sm text-gray-600 mb-3">Share your plan with council officers, NRM advisors, or contractors.</p>
                                <div className="flex gap-2">
                                    <button 
                                        onClick={emailReport}
                                        className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 cursor-pointer"
                                    >
                                        <i className="fas fa-envelope mr-2"></i>
                                        Email Report
                                    </button>
                                    <button 
                                        onClick={printSummary}
                                        className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 cursor-pointer"
                                    >
                                        <i className="fas fa-print mr-2"></i>
                                        Print Summary
                                    </button>
                                </div>
                            </div>
                            
                            <div className="p-4 bg-gray-50 rounded-lg">
                                <h4 className="font-bold mb-2">Save Progress</h4>
                                <p className="text-sm text-gray-600 mb-3">Your progress is automatically saved. You can also create a backup.</p>
                                <div className="flex gap-2">
                                    <button 
                                        onClick={createBackup}
                                        className="px-4 py-2 border rounded-lg hover:bg-gray-50 cursor-pointer"
                                    >
                                        <i className="fas fa-save mr-2"></i>
                                        Create Backup
                                    </button>
                                    <button 
                                        onClick={clearLocalStorage}
                                        className="px-4 py-2 border border-red-300 text-red-600 rounded-lg hover:bg-red-50 cursor-pointer"
                                    >
                                        <i className="fas fa-trash mr-2"></i>
                                        Clear All Data
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));

        // Accordion functionality for help modal
        document.addEventListener('DOMContentLoaded', function() {
            // This will run when the modal is opened
            const initAccordions = () => {
                document.querySelectorAll('.accordion-header').forEach(header => {
                    header.addEventListener('click', () => {
                        const content = header.nextElementSibling;
                        const icon = header.querySelector('i');
                        
                        // Close all other accordions
                        document.querySelectorAll('.accordion-content').forEach(c => {
                            if (c !== content) {
                                c.style.display = 'none';
                                c.previousElementSibling.querySelector('i').classList.remove('fa-chevron-up');
                                c.previousElementSibling.querySelector('i').classList.add('fa-chevron-down');
                            }
                        });
                        
                        // Toggle current
                        if (content.style.display === 'block') {
                            content.style.display = 'none';
                            icon.classList.remove('fa-chevron-up');
                            icon.classList.add('fa-chevron-down');
                        } else {
                            content.style.display = 'block';
                            icon.classList.remove('fa-chevron-down');
                            icon.classList.add('fa-chevron-up');
                        }
                    });
                });
            };
            
            // Initialize accordions when help modal is opened
            window.initHelpAccordions = initAccordions;
        });
    </script>
</body>
</html>
